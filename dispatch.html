<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Out Fashion - Order Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Professional & User-Friendly Color Palette */
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-card-section: #f1f3f5;
            --color-primary: #005A9C; /* A professional, deep blue */
            --color-primary-hover: #004B80;
            --color-secondary: #6c757d; /* Muted gray for secondary text */
            --text-primary: #212529; /* Dark charcoal for primary text */
            --border-color: #dee2e6;
            --border-focus: #80bdff;
            --danger: #d9534f;
            --danger-hover: #c9302c;
            --success: #5cb85c;
            --success-hover: #4cae4c;
            --warning: #f0ad4e;
            --warning-hover: #ec971f;
            --info: #5bc0de;
            --info-hover: #31b0d5;
        }
        
        /* Background Animation Keyframes */
        @keyframes subtleGradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* General Styles */
        html { height: 100%; }
        body {
            /* Centering the container */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            
            /* Animated Background */
            background: linear-gradient(-45deg, #e7f5ff, #f8f9fa, #e9ecef, #dee2e6);
            background-size: 400% 400%;
            animation: subtleGradientAnimation 30s ease infinite;

            color: var(--text-primary);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #e9ecef; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 10px; }

        /* Card and Container Styles */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            /* Set a max-width to prevent stretching */
            max-width: 1200px; 
            width: 100%;
        }
        .bg-card-section {
            background-color: var(--bg-card-section);
        }
        .border-theme {
            border-color: var(--border-color);
        }

        /* Text and Headers */
        h1, h2 { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }

        /* Buttons */
        .btn { transition: background-color .2s, transform .1s, box-shadow .2s; border: none; }
        .btn:active { transform: scale(.98); }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #e9ecef; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #ced4da; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: var(--info-hover); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-warning:hover { background-color: var(--warning-hover); }

        /* Inputs and Forms */
        input, select, textarea {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-lg */
        }
        input::placeholder, textarea::placeholder { color: var(--color-secondary); opacity: 0.8; }
        input:focus, select:focus, textarea:focus {
             outline: none;
             border-color: var(--border-focus);
             box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        /* Status Messages */
        .status-message { transition: all .4s ease-in-out; opacity: 0; transform: translateY(-15px); max-height: 0; margin-top: 0; }
        .status-message.show { opacity: 1; transform: translateY(0); max-height: 100px; padding: .75rem; margin-top: .75rem; }
        .bg-green-status { background-color: #dff0d8; border: 1px solid #d6e9c6; color: #3c763d; }
        .bg-red-status { background-color: #f2dede; border: 1px solid #ebccd1; color: #a94442; }
        .auto-save-status { opacity: 0; transition: opacity .5s ease; color: var(--success); }
        .auto-save-status.show { opacity: 1; }
        
        /* Camera Modal */
        #camera-modal { display: none; }
        #camera-modal.show { display: flex; }

        /* Print Styles */
        @media print {
            body { 
                display: block; /* Override flex for printing */
                background: #fff !important; 
            }
            .card {
                box-shadow: none !important;
                border: none !important;
                max-width: 100% !important;
            }
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; padding: 5mm; box-sizing: border-box; font-family: 'Arial', sans-serif; color: #000; }
            .no-print { display: none !important; }
            .print-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
            .print-title-group { display: flex; align-items: center; gap: 15px; }
            .print-header .company-logo { height: 40px; }
            .print-header .company-name-print { font-family: 'Impact', 'Arial Narrow Bold', sans-serif; font-size: 18pt; letter-spacing: 1px; }
            .print-header .print-date { font-size: 10pt; font-weight: bold; }
            #printBarcodeList { column-count: 5; column-gap: 15px; font-size: 9pt; }
            .print-column { break-inside: avoid; padding-right: 10px; }
            .print-column div { margin-bottom: 4px; white-space: nowrap; }
        }
        @keyframes slideInFromLeft{ from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }

        /* Custom SVG Icon Styling */
        .icon-online { color: var(--success); }
        .icon-offline { color: var(--danger); }
        
        /* NEW: Blinking Effect for Time Alert */
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        .blinking-alert {
            animation: blink 1s step-start infinite;
            color: var(--danger) !important; 
        }

        /* NEW: Flip Counter Styles based on image */
        .flip-counter {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: 'Impact', monospace; /* Use monospaced font for digits */
        }
        .flip-digit-container {
            position: relative;
            width: 35px; /* Wider digits */
            height: 50px; 
            overflow: hidden;
            background-color: #212529; /* Dark background matching the image */
            border-radius: 4px;
            margin: 0 1px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            perspective: 200px; /* For potential 3D flip effect */
        }
        /* Style for the light green separator, applied only between digits */
        .flip-digit-container:not(:last-child):after {
             content: '';
             position: absolute;
             right: -2px; /* Position separator slightly outside the digit box */
             top: 0;
             width: 1px;
             height: 100%;
             background-color: #8fbc8f; /* Light green separator color from image */
             z-index: 10;
        }
        .flip-digit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white; /* White digits from image */
            backface-visibility: hidden;
            line-height: 1;
            /* Initial state of the 'next' digit, pushed down */
            transform: translateY(100%);
        }
        /* Ensure the current digit starts visible */
        .flip-digit.current {
            transform: translateY(0%);
        }

        /* NEW: Sync Progress Bar Styles */
        #syncProgressBarContainer {
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        #syncProgressBar {
            height: 100%;
            width: 0%;
            background-color: var(--color-primary); /* Use theme primary color for progress */
            transition: width 1s linear; /* Smooth transition for 1 second intervals */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="p-4 lg:p-8">

    <!-- Main Application -->
    <div id="app-container" class="card p-6 lg:p-8 rounded-2xl w-full no-print">
        <header class="flex justify-between items-center mb-6 flex-wrap gap-4 border-b border-theme pb-4">
            <div class="flex items-center gap-4">
                <img src="logo.png" alt="Company Logo" class="h-12">
                <h1 id="appTitle" class="text-2xl lg:text-3xl font-bold"></h1>
            </div>
            <div id="live-clock" class="text-lg lg:text-xl font-semibold text-secondary order-3 lg:order-2 w-full lg:w-auto text-center"></div>
        </header>
        
        <main class="flex flex-col lg:flex-row gap-8 mt-4">
            <!-- Left Column -->
            <section class="w-full lg:w-3/5 flex flex-col gap-y-6">
                <p id="scanOrderDescription" class="text-center text-secondary -mt-2"></p>
                
                <!-- Removed: Simple Unique Order Count Display was here -->

                <div>
                     <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="orderScanInput" class="flex-grow p-3 shadow-sm" />
                        <button id="addOrderBarcodeBtn" class="px-5 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                        <button id="openCameraBtn" class="p-3 rounded-lg font-semibold shadow-md btn btn-info" aria-label="Scan with camera">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                    <div id="statusMessage" class="status-message rounded-lg text-center font-semibold p-3"></div>
                </div>
                <div>
                    <h2 id="scannedListHeader" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                    <div id="orderListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-60 lg:max-h-96 overflow-y-auto shadow-inner">
                        <ul id="scannedOrderBarcodesList" class="space-y-2">
                            <p id="noOrderBarcodesMessage" class="text-secondary text-center py-4"></p>
                        </ul>
                    </div>
                </div>
                 <button id="returnToTodayBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-secondary"></button>
            </section>

            <!-- Right Column -->
            <aside class="w-full lg:w-2/5 flex flex-col gap-y-8">
                <!-- Network Status Display and Animated Counter -->
                <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                    <div class="mb-4">
                        <!-- Connection Status -->
                        <div id="connectionStatus" class="flex items-center justify-center gap-2 mb-2 p-2 rounded-lg border border-gray-300">
                            <span class="font-semibold text-sm text-secondary">Connection:</span>
                            <!-- Icon and Text will be updated by JavaScript -->
                            <span id="networkIcon" class="text-xl"></span>
                            <span id="networkText" class="font-bold">Checking...</span>
                        </div>

                        <!-- NEW: Animated Barcode Count Display -->
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center shadow-inner mt-4">
                            <p class="text-lg font-semibold text-primary mb-2" id="uniqueOrderCountLabel"></p>
                            <div id="animatedCounter" class="flex justify-center items-center h-14">
                                <!-- Digits will be added here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-gray-300">

                    <!-- NEW: Auto Sync Toggle Button & Progress Bar -->
                    <div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm text-secondary">Multi-Device Sync (1 min):</span>
                            <button id="toggleAutoSyncBtn" class="px-3 py-1 text-sm rounded-lg font-semibold shadow-md transition-colors">
                                <!-- Text and class updated by JS -->
                            </button>
                        </div>
                        <div id="syncProgressBarContainer">
                            <div id="syncProgressBar"></div>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit -mt-4">
                     <h2 id="exportTitle" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                     <button id="saveToSheetBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-warning">
                        <span id="saveBtnText">Save to Google Sheet</span>
                        <div id="saveBtnSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
                     </button>
                     <p id="sheetStatus" class="text-center text-sm h-4 mt-2"></p>
                     <hr class="my-4 border-gray-300">
                     <button id="printScannedOrderBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-info"></button>
                     <button id="downloadCsvBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-success"></button>
                </div>
                <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-theme">
                        <h2 id="loadPreviousOrdersTitle" class="text-xl font-bold"></h2>
                        <span id="autoSaveStatus" class="auto-save-status font-semibold text-sm">✓ Saved</span>
                    </div>

                    <div class="mb-4">
                        <label for="barcodeSearchInput" class="block mb-2 text-sm font-medium text-secondary">Search Barcode</label>
                        <div class="flex gap-2">
                            <input type="text" id="barcodeSearchInput" placeholder="Enter barcode to find..." class="w-full p-2">
                            <button id="barcodeSearchBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-info">Search</button>
                        </div>
                        <p id="barcodeSearchResult" class="text-center text-sm h-4 mt-2"></p>
                    </div>
                    <hr class="my-4 border-gray-300">
                    
                    <div id="liveSessionDisplay" class="mb-2 p-3 bg-green-100 rounded-lg text-center border border-green-200 hidden">
                        <p class="text-sm text-green-800">Live Session:</p>
                        <p id="liveSessionName" class="font-bold text-lg text-green-900"></p>
                    </div>
                    
                    <button id="manualSaveBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn btn-success text-sm">
                        <span id="manualSaveBtnText">Save Current Session</span>
                        <div id="manualSaveBtnSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>
                    </button>
                    
                    <div class="mb-4">
                         <label id="searchByDateLabel" for="searchByDate" class="block mb-2 text-sm font-medium text-secondary"></label>
                         <div class="flex gap-2">
                            <input type="date" id="searchByDate" class="w-full p-2">
                            <button id="resetDateFilterBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-secondary text-xs"></button>
                         </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="savedSessionsSelect" class="flex-grow p-3"><option value=""></option></select>
                        <button id="loadSelectedSessionBtn" class="px-6 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                    </div>
                    <button id="deleteSelectedSessionBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-danger"></button>
                </div>
            </aside>
        </main>
    </div>
    
    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4 text-center text-primary">Scan Barcode</h3>
            <div id="reader" width="100%"></div>
            <button id="closeCameraBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-danger">Close Camera</button>
        </div>
    </div>

    <!-- PRINT AREA -->
    <div id="print-area" class="hidden">
        <div class="print-header">
            <div class="print-title-group">
                <img src="logo.png" alt="Company Logo" class="company-logo">
                <h1 class="company-name-print">World Out Fashion</h1>
            </div>
            <p class="print-date" id="printDate"></p>
        </div>
        <div id="printBarcodeList"></div>
    </div>

    <!-- Local audio files as per original request -->
    <!-- Re-added the original audio tags -->
    <audio id="successSound" src="play.mp3" preload="auto"></audio>
    <audio id="errorSound" src="error.mp3" preload="auto"></audio>

    <script>
        // =========================================================================
        // === වැදගත්: මෙතනට ඔබගේ Google Apps Script URL එක ඇතුළත් කරන්න ===
        // =========================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuYsSzGAmbFUClFQEWYbPSYyDKeh3CJn8dn5yPZ4AhFxZtBseTCYurxirFRAzJ25KO/exec"; 
        // =========================================================================

        let scannedBarcodes = [];
        let currentSessionId = null;
        let currentlyViewingBarcodes = [];
        let currentlyViewingSessionId = null;
        let allSessions = [];
        let html5QrCode = null;
        
        // Time Alert Variables
        let minuteBeepTimeout = null;
        let isBeepingActive = false;
        
        // NEW: Auto-Sync Variables
        let autoSyncInterval = null;
        let isAutoSyncEnabled = false; // <<< DEFAULT IS NOW FALSE (OFF)
        let syncProgressTimeout = null;

        const el = {
            appContainer: document.getElementById('app-container'), appTitle: document.getElementById("appTitle"), scanOrderDescription: document.getElementById("scanOrderDescription"), uniqueOrderCountLabel: document.getElementById("uniqueOrderCountLabel"), orderScanInput: document.getElementById("orderScanInput"), addOrderBarcodeBtn: document.getElementById("addOrderBarcodeBtn"), statusMessage: document.getElementById("statusMessage"), scannedListHeader: document.getElementById("scannedListHeader"), scannedOrderBarcodesList: document.getElementById("scannedOrderBarcodesList"), noOrderBarcodesMessage: document.getElementById("noOrderBarcodesMessage"), orderListContainer: document.getElementById("orderListContainer"), returnToTodayBtn: document.getElementById("returnToTodayBtn"), exportTitle: document.getElementById("exportTitle"), printScannedOrderBtn: document.getElementById("printScannedOrderBtn"), downloadCsvBtn: document.getElementById("downloadCsvBtn"), loadPreviousOrdersTitle: document.getElementById("loadPreviousOrdersTitle"), autoSaveStatus: document.getElementById("autoSaveStatus"), searchByDateLabel: document.getElementById("searchByDateLabel"), searchByDate: document.getElementById("searchByDate"), resetDateFilterBtn: document.getElementById("resetDateFilterBtn"), savedSessionsSelect: document.getElementById("savedSessionsSelect"), loadSelectedSessionBtn: document.getElementById("loadSelectedSessionBtn"), deleteSelectedSessionBtn: document.getElementById("deleteSelectedSessionBtn"), liveClock: document.getElementById("live-clock"), saveToSheetBtn: document.getElementById('saveToSheetBtn'), saveBtnText: document.getElementById('saveBtnText'), saveBtnSpinner: document.getElementById('saveBtnSpinner'), sheetStatus: document.getElementById('sheetStatus'), liveSessionDisplay: document.getElementById('liveSessionDisplay'), liveSessionName: document.getElementById('liveSessionName'), manualSaveBtn: document.getElementById('manualSaveBtn'), manualSaveBtnText: document.getElementById('manualSaveBtnText'), manualSaveBtnSpinner: document.getElementById('manualSaveBtnSpinner'), barcodeSearchInput: document.getElementById('barcodeSearchInput'), barcodeSearchBtn: document.getElementById('barcodeSearchBtn'), barcodeSearchResult: document.getElementById('barcodeSearchResult'),
            cameraModal: document.getElementById('camera-modal'), openCameraBtn: document.getElementById('openCameraBtn'), closeCameraBtn: document.getElementById('closeCameraBtn'),
            // Network Status Elements
            connectionStatus: document.getElementById('connectionStatus'),
            networkIcon: document.getElementById('networkIcon'),
            networkText: document.getElementById('networkText'),
            // Animated Counter Element
            animatedCounter: document.getElementById('animatedCounter'),
            // NEW: Auto Sync Toggle Button
            toggleAutoSyncBtn: document.getElementById('toggleAutoSyncBtn'),
            // NEW: Progress Bar Elements
            syncProgressBar: document.getElementById('syncProgressBar'),
        };

        // --- NEW: ANIMATED FLIP COUNTER LOGIC ---
        const FlipCounter = {
            element: null,
            value: 0,
            digitContainers: [],
            
            initialize: function(initialValue = 0) {
                this.element = el.animatedCounter;
                this.element.classList.add('flip-counter');
                this.update(initialValue, true);
            },
            
            update: function(newValue, noAnimation = false) {
                if (newValue < 0) newValue = 0;
                // Pad up to 4 digits for a consistent display (max 9999 orders)
                const oldValueStr = String(this.value).padStart(4, '0');
                this.value = newValue;
                const newValueStr = String(newValue > 9999 ? 9999 : newValue).padStart(4, '0'); // Limit to 9999
                
                // Ensure there are 4 digit containers
                while (this.digitContainers.length < 4) {
                    const container = document.createElement('div');
                    container.className = 'flip-digit-container';
                    // Inside container: two layers, one for current, one for next
                    container.innerHTML = `<div class="flip-digit current">0</div><div class="flip-digit next">0</div>`;
                    // FIX: Ensure 'this.element' exists before appending
                    if (this.element) {
                        this.element.appendChild(container);
                    }
                    this.digitContainers.push(container);
                }

                for (let i = 0; i < 4; i++) {
                    const newDigit = newValueStr[i];
                    const oldDigit = oldValueStr[i];
                    const container = this.digitContainers[i];

                    if (newDigit !== oldDigit || noAnimation) {
                        this.animateDigit(container, oldDigit, newDigit, noAnimation);
                    }
                }
            },
            
            animateDigit: function(container, oldDigit, newDigit, noAnimation) {
                const currentElement = container.querySelector('.current');
                const nextElement = container.querySelector('.next');
                
                if (noAnimation) {
                    currentElement.textContent = newDigit;
                    nextElement.textContent = newDigit;
                    currentElement.style.transform = 'translateY(0%)';
                    return;
                }

                // 1. Initial State Setup
                nextElement.textContent = newDigit;
                
                // Reset positions (instant, no transition)
                currentElement.style.transition = 'none';
                nextElement.style.transition = 'none';
                currentElement.style.transform = 'translateY(0%)';
                nextElement.style.transform = 'translateY(100%)';
                
                // 2. Start Animation (after reflow/delay)
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        currentElement.style.transition = 'transform 0.5s ease-out';
                        nextElement.style.transition = 'transform 0.5s ease-out';

                        currentElement.style.transform = 'translateY(-100%)'; // Move current digit up
                        nextElement.style.transform = 'translateY(0%)';      // Move next digit up to replace
                        
                        // 3. Final State (Swap content and reset for next animation)
                        setTimeout(() => {
                            // Set the final state immediately after the transition ends
                            currentElement.textContent = newDigit;
                            
                            // Reset position by instantly moving back to 0% after animation
                            currentElement.style.transition = 'none';
                            currentElement.style.transform = 'translateY(0%)';
                            nextElement.style.transition = 'none';
                            nextElement.style.transform = 'translateY(100%)';
                            
                        }, 500); // Match CSS transition duration
                    });
                });
            }
        };

        // --- NEW: AUTO SYNC CONTROL LOGIC ---
        const SYNC_INTERVAL_MS = 60000; // 60 seconds

        function updateSyncButton() {
            if (isAutoSyncEnabled) {
                el.toggleAutoSyncBtn.textContent = "Sync ON";
                el.toggleAutoSyncBtn.className = "px-3 py-1 text-sm rounded-lg font-semibold shadow-md transition-colors btn btn-success";
                el.toggleAutoSyncBtn.setAttribute('title', 'Auto-sync is active. Data refreshes every minute from the server.');
                startSyncProgress();
            } else {
                el.toggleAutoSyncBtn.textContent = "Sync OFF";
                el.toggleAutoSyncBtn.className = "px-3 py-1 text-sm rounded-lg font-semibold shadow-md transition-colors btn btn-danger";
                el.toggleAutoSyncBtn.setAttribute('title', 'Auto-sync is disabled. Refresh manually to get data from other devices.');
                stopSyncProgress();
            }
        }

        function startSyncProgress() {
            stopSyncProgress();
            el.syncProgressBar.style.transition = 'none';
            el.syncProgressBar.style.width = '0%';
            
            let progress = 0;
            const step = (100 / (SYNC_INTERVAL_MS / 1000)); // 1.666% per second
            
            // Set transition for smooth filling
            requestAnimationFrame(() => {
                el.syncProgressBar.style.transition = 'width 1s linear';
            });
            
            syncProgressTimeout = setInterval(() => {
                if (progress < 100) {
                    progress += step;
                    el.syncProgressBar.style.width = `${progress}%`;
                } else {
                    // Reset to 0 just before the actual data refresh, but keep the animation smooth
                    progress = 0;
                    el.syncProgressBar.style.transition = 'none';
                    el.syncProgressBar.style.width = '0%';
                    requestAnimationFrame(() => {
                         el.syncProgressBar.style.transition = 'width 1s linear';
                    });
                }
            }, 1000); // Update every second
        }

        function stopSyncProgress() {
            if (syncProgressTimeout) {
                clearInterval(syncProgressTimeout);
                syncProgressTimeout = null;
            }
            el.syncProgressBar.style.transition = 'none';
            el.syncProgressBar.style.width = '0%';
        }


        function startAutoSync() {
            if (!autoSyncInterval) {
                autoSyncInterval = setInterval(async () => {
                    if (navigator.onLine && currentlyViewingSessionId === currentSessionId) {
                        // isSync = true, so status message shows 'Synced' briefly
                        await reloadTodaysData(true); 
                    }
                }, SYNC_INTERVAL_MS); 
            }
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        function toggleAutoSync() {
            isAutoSyncEnabled = !isAutoSyncEnabled;
            updateSyncButton();
            if (isAutoSyncEnabled) {
                startAutoSync();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Auto-Sync ON', showConfirmButton: false, timer: 1500 });
            } else {
                stopAutoSync();
                Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Auto-Sync OFF', showConfirmButton: false, timer: 1500 });
            }
        }

        // --- CORE & HELPER FUNCTIONS ---
        function setInitialTexts() { 
            el.appTitle.textContent = "Order Management System"; 
            el.scanOrderDescription.textContent = "Scan order items for today's session."; 
            el.uniqueOrderCountLabel.textContent = "Total Scanned"; // Used for the new counter label
            el.addOrderBarcodeBtn.textContent = "Add"; 
            el.returnToTodayBtn.textContent = "Return to Today's Session"; 
            el.exportTitle.textContent = "Export & Save"; 
            el.printScannedOrderBtn.textContent = "Print Viewed List (A4)"; 
            el.downloadCsvBtn.textContent = "Download Viewed List (CSV)"; 
            el.loadPreviousOrdersTitle.textContent = "View Previous Sessions"; 
            el.searchByDateLabel.textContent = "Filter by Date"; 
            el.resetDateFilterBtn.textContent = "Reset"; 
            el.loadSelectedSessionBtn.textContent = "View"; 
            el.deleteSelectedSessionBtn.textContent = "Delete"; 
            el.orderScanInput.placeholder = "Barcode number..."; 
            el.savedSessionsSelect.innerHTML = `<option value="">Loading...</option>`; 
            el.manualSaveBtnText.textContent = "Save Current Session"; 
        }
        
        function updateClock() { 
            const now = new Date();
            el.liveClock.textContent = now.toLocaleString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: !0 }); 
            
            // NEW: Blinking Logic (7:15 PM to 8:00 PM local time)
            const hour = now.getHours();
            const minute = now.getMinutes();

            // Check if time is between 19:15:00 and 20:00:00 (exclusive of 20:00:00)
            const isAlertTime = (hour === 19 && minute >= 15) || (hour === 20 && minute === 0);
            
            if (isAlertTime && hour < 20) {
                el.liveClock.classList.add('blinking-alert');
                el.appTitle.classList.add('blinking-alert'); // Also blink the title for visibility
            } else {
                el.liveClock.classList.remove('blinking-alert');
                el.appTitle.classList.remove('blinking-alert');
            }
            
            // Check if beep system needs to be started or stopped
            updateBeepAlert(isAlertTime && hour < 20, now);
        }

        // Re-enabled audio playback with error handling
        function playSuccessSound() {
            const successAudio = document.getElementById('successSound');
            if (successAudio) { 
                successAudio.pause(); 
                successAudio.currentTime = 0; 
                successAudio.play().catch(error => console.error("Success sound playback failed:", error)); 
            }
        }

        function playErrorSound() {
            const errorAudio = document.getElementById('errorSound');
            if (errorAudio) { 
                errorAudio.pause(); 
                errorAudio.currentTime = 0; 
                errorAudio.play().catch(error => console.error("Error sound playback failed:", error)); 
            }
        }
        
        function updateBeepAlert(isAlertTime, now) {
            if (isAlertTime && !isBeepingActive) {
                // START Beeping
                isBeepingActive = true;
                
                // Calculate time until the next minute start
                const secondsToNextMinute = 60 - now.getSeconds();
                
                // Set the initial beep after the calculated time
                minuteBeepTimeout = setTimeout(() => {
                    playErrorSound(); // Use error sound for the alert beep
                    
                    // Set up interval for subsequent beeps (every 60 seconds)
                    minuteBeepTimeout = setInterval(() => {
                        // Check time again before beeping to ensure we don't beep at exactly 20:00:00
                        const current = new Date();
                        const currentHour = current.getHours();
                        const currentMinute = current.getMinutes();
                        const isStillAlertTime = (currentHour === 19 && currentMinute >= 15) || (currentHour === 20 && currentMinute === 0);

                        if (isStillAlertTime && currentHour < 20) {
                           playErrorSound();
                        } else {
                            // Stop Beeping when the window closes (at 20:00:00)
                            clearInterval(minuteBeepTimeout);
                            isBeepingActive = false;
                        }
                    }, 60000); // 60 seconds
                    
                }, secondsToNextMinute * 1000);

            } else if (!isAlertTime && isBeepingActive) {
                // STOP Beeping (If outside the window but interval is still running)
                clearTimeout(minuteBeepTimeout);
                clearInterval(minuteBeepTimeout);
                isBeepingActive = false;
            }
        }

        function showStatusMessage(t, e) { el.statusMessage.textContent = t; el.statusMessage.className = "status-message rounded-lg text-center font-semibold p-3"; el.statusMessage.classList.add("success" === e ? "bg-green-status" : "bg-red-status", "show"); setTimeout(() => el.statusMessage.classList.remove("show"), 2500); }
        function getTodaySessionId() { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); return `SESSION-${yyyy}-${mm}-${dd}`; }
        
        // --- API COMMUNICATION ---
       async function apiCall(action, payload = {}) {
            // Check network status before making an API call
            if (!navigator.onLine && action !== 'getSessionData' && action !== 'getAllSessions') {
                 Swal.fire("Offline Error", "Cannot perform this action while offline. Please check your internet connection.", "error");
                 throw new Error("Offline");
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message || 'Unknown script error.');
                return data;
            } catch (error) {
                console.error(`API Call Failed for action "${action}":`, error);
                
                // FIX: Removed the generic pop-up for API errors to stop "Failed to fetch" spam. 
                // We keep the console log and the more specific pop-ups (e.g., Session not found, Offline).

                if (error.message.includes('Failed to fetch')) {
                    // Specific silent handling for common 'Failed to fetch' error (often due to CORS/network setup)
                    console.warn(`Silent API Warning: Failed to communicate with script URL. Check URL or network.`);
                }
                
                if (!error.message.includes('Session not found') && error.message !== 'Offline' && !error.message.includes('Failed to fetch')) {
                    // Only show specific, relevant errors to the user
                    Swal.fire("API Error", `An error occurred while communicating with the server: ${error.message}`, "error");
                }
                
                throw error; // Propagate error for calling functions to handle
            }
        }
        
        // --- NETWORK STATUS LOGIC ---
        function getWifiIcon(colorClass) {
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${colorClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.447 18.013v0c.34-.146.732-.23 1.144-.23h4.818c.412 0 .804.084 1.144.23l.115.05A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373L7.15 7.189c.34-.146.732-.23 1.144-.23h7.411c.412 0 .804.084 1.144.23l.23-.23A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373zM5 12a7 7 0 0114 0M3 18a9 9 0 0118 0" />
                </svg>
            `;
        }

        function updateNetworkStatus() {
            if (navigator.onLine) {
                el.networkIcon.innerHTML = getWifiIcon("icon-online"); // Green Wi-Fi Icon
                el.networkText.textContent = "Online";
                el.networkText.className = "font-bold text-success-hover";
            } else {
                el.networkIcon.innerHTML = getWifiIcon("icon-offline"); // Red Wi-Fi Icon
                el.networkText.textContent = "Offline";
                el.networkText.className = "font-bold text-danger-hover";
                // Only show SweetAlert on state change to prevent spam
                if(el.networkText.textContent !== "Offline") {
                     Swal.fire("Offline Mode", "The application is currently offline. Data saving to Google Sheet is disabled.", "warning");
                }
            }
            // Disable saving to sheet when offline
            el.saveToSheetBtn.disabled = !navigator.onLine;
            el.manualSaveBtn.disabled = !navigator.onLine;
        }

        // --- UI & STATE MANAGEMENT ---
        function updateUiFromState() {
            const currentCount = currentlyViewingBarcodes.length;
            
            // FIX: Check if FlipCounter is initialized before calling update
            if (FlipCounter.element) {
                FlipCounter.update(currentCount); 
            }

            el.scannedOrderBarcodesList.innerHTML = "";
            const hasBarcodes = currentCount > 0;
            const isViewingToday = currentlyViewingSessionId === currentSessionId;
            
            el.scannedListHeader.textContent = isViewingToday ? "Scanned Barcodes (Today)" : `Viewing Session: ${currentlyViewingSessionId.replace('SESSION-','')}`;
            el.noOrderBarcodesMessage.textContent = isViewingToday ? "No barcodes scanned yet for today." : "No barcodes were scanned on this day.";
            el.noOrderBarcodesMessage.style.display = hasBarcodes ? 'none' : 'block';
            el.returnToTodayBtn.style.display = isViewingToday ? 'none' : 'block';
            el.orderScanInput.disabled = !isViewingToday; el.addOrderBarcodeBtn.disabled = !isViewingToday; el.openCameraBtn.disabled = !isViewingToday;
            el.orderScanInput.placeholder = isViewingToday ? "Barcode number..." : "Viewing past session...";

            if (hasBarcodes) {
                currentlyViewingBarcodes.forEach((barcode, index) => {
                    const listItem = document.createElement("li");
                    listItem.style.animation = `slideInFromLeft 0.5s ease-out forwards`;
                    const scanNumber = currentlyViewingBarcodes.length - index;
                    if(isViewingToday) {
                        listItem.className = "flex items-center justify-between p-2 rounded-md text-base bg-white shadow-sm border border-gray-200 text-gray-800";
                        const leftDiv = document.createElement('div'); leftDiv.className = 'flex items-center';
                        const numberSpan = document.createElement('span'); numberSpan.className = "font-semibold text-primary w-12 text-left"; numberSpan.textContent = `#${scanNumber}`;
                        const barcodeSpan = document.createElement('span'); barcodeSpan.textContent = barcode;
                        leftDiv.appendChild(numberSpan); leftDiv.appendChild(barcodeSpan);
                        const deleteBtn = document.createElement('button'); deleteBtn.textContent = "Delete"; deleteBtn.className = "btn btn-danger px-3 py-1 text-xs rounded-md font-semibold"; deleteBtn.onclick = () => handleDeleteSingleBarcode(scanNumber - 1);
                        listItem.appendChild(leftDiv); listItem.appendChild(deleteBtn);
                    } else {
                        listItem.className = "flex items-center p-2 text-gray-500";
                        listItem.textContent = `#${scanNumber}. ${barcode}`;
                    }
                    el.scannedOrderBarcodesList.appendChild(listItem);
                });
                el.orderListContainer.scrollTop = 0;
            }
            el.liveSessionName.textContent = `For ${currentSessionId.replace('SESSION-', '')}`;
            el.liveSessionDisplay.classList.remove('hidden');
            
            // Re-apply network/save status after UI update
            updateNetworkStatus();
        }
        
        // --- APPLICATION LOGIC ---
        async function initializeApp() {
            setInitialTexts(); 
            
            // FIX: Initialize Flip Counter *before* loading data and calling updateUiFromState
            FlipCounter.initialize(0); 
            
            updateClock(); 
            // Update clock and check for time alert every second
            setInterval(updateClock, 1000); 
            
            // Auto-sync initialization and event listener
            el.toggleAutoSyncBtn.addEventListener('click', toggleAutoSync);
            // Default Sync is OFF, so we initialize the button state and do NOT start the sync interval
            updateSyncButton(); 
            // stopAutoSync() is implicitly called because isAutoSyncEnabled is false

            currentSessionId = getTodaySessionId(); document.title = "World Out Fashion - OMS";
            el.orderScanInput.addEventListener("keypress", (e) => { if (e.key === 'Enter') handleOrderScanAddBarcode(); });
            el.addOrderBarcodeBtn.addEventListener("click", handleOrderScanAddBarcode);
            el.returnToTodayBtn.addEventListener("click", returnToTodayView);
            el.manualSaveBtn.addEventListener("click", handleManualSave);
            el.loadSelectedSessionBtn.addEventListener("click", loadSelectedSession);
            el.deleteSelectedSessionBtn.addEventListener("click", deleteSelectedSession);
            el.searchByDate.addEventListener("input", filterSessionsByDate);
            el.resetDateFilterBtn.addEventListener("click", () => { el.searchByDate.value = ""; filterSessionsByDate(); });
            el.barcodeSearchBtn.addEventListener("click", handleBarcodeSearch);
            el.barcodeSearchInput.addEventListener("keypress", (e) => { if (e.key === 'Enter') handleBarcodeSearch(); });
            el.saveToSheetBtn.addEventListener("click", saveDataToGoogleSheet);
            el.printScannedOrderBtn.addEventListener("click", printScannedOrder);
            el.downloadCsvBtn.addEventListener("click", downloadCsv);
            el.openCameraBtn.addEventListener("click", startCameraScan);
            el.closeCameraBtn.addEventListener("click", stopCameraScan);

            // Network Initialization
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus(); // Initial network check
            
            await reloadTodaysData();
            
            // Initial data load will call returnToTodayView which calls updateUiFromState.
            
            try { const data = await apiCall("getAllSessions"); allSessions = data.sessions; filterSessionsByDate(); } catch (error) { /* Handled by apiCall */ }
        }
        
        async function reloadTodaysData(isSync = false) {
             try { 
                 const data = await apiCall("getSessionData", { sessionId: currentSessionId }); 
                 const newBarcodes = data.session.data.barcodes || [];
                 
                 // Only update if there's a difference to avoid unnecessary UI redraws
                 if (JSON.stringify(scannedBarcodes) !== JSON.stringify(newBarcodes)) {
                    scannedBarcodes = newBarcodes;
                    // Only update viewing list if we are currently viewing today's session
                    if (currentlyViewingSessionId === currentSessionId) {
                        currentlyViewingBarcodes = [...scannedBarcodes];
                        updateUiFromState();
                        if (isSync) {
                            // Show a brief sync status
                            el.autoSaveStatus.textContent = '✓ Synced'; el.autoSaveStatus.style.color = 'var(--info)'; el.autoSaveStatus.classList.add("show"); 
                            setTimeout(() => { el.autoSaveStatus.classList.remove("show"); el.autoSaveStatus.textContent = '✓ Saved'; el.autoSaveStatus.style.color = 'var(--success)'; }, 1500);
                        }
                    }
                 }
             } 
             catch (error) { 
                 if (error.message.includes('Session not found')) { 
                     scannedBarcodes = []; 
                 }
                 // Do not show general API error for sync attempts
             }
             if (!isSync) {
                 returnToTodayView();
             }
        }
        
        function handleOrderScanAddBarcode() {
            const barcode = el.orderScanInput.value.trim();
            if (barcode === "") return;
            if (scannedBarcodes.includes(barcode)) {
                showStatusMessage(`Already Scanned: ${barcode}`, "error");
                playErrorSound();
            } else {
                scannedBarcodes.unshift(barcode);
                currentlyViewingBarcodes = scannedBarcodes;
                showStatusMessage(`Success: ${barcode}`, "success");
                playSuccessSound();
                updateUiFromState();
                autoSaveSession();
            }
            el.orderScanInput.value = "";
            el.orderScanInput.focus();
        }
        
        function handleDeleteSingleBarcode(reverseIndex) {
            const actualIndex = scannedBarcodes.length - 1 - reverseIndex;
            Swal.fire({ title: 'Are you sure?', text: `Do you want to permanently delete this barcode?`, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--danger)', confirmButtonText: 'Yes, delete it!', cancelButtonText: 'Cancel'
            }).then((result) => { if (result.isConfirmed) { scannedBarcodes.splice(actualIndex, 1); currentlyViewingBarcodes = scannedBarcodes; updateUiFromState(); autoSaveSession(); } });
        }
        
        function returnToTodayView() {
            currentlyViewingSessionId = currentSessionId; currentlyViewingBarcodes = [...scannedBarcodes]; updateUiFromState();
        }
        
        async function loadSelectedSession() {
            const sessionId = el.savedSessionsSelect.value;
            if (!sessionId) { return Swal.fire({ title: "Please select a session to view.", icon: 'info' }); }
            el.loadSelectedSessionBtn.disabled = true; el.loadSelectedSessionBtn.textContent = "Loading...";
            try { const data = await apiCall("getSessionData", { sessionId: sessionId }); currentlyViewingSessionId = sessionId; currentlyViewingBarcodes = data.session.data.barcodes || []; updateUiFromState(); } 
            catch (error) { returnToTodayView(); } 
            finally { el.loadSelectedSessionBtn.disabled = false; el.loadSelectedSessionBtn.textContent = "View"; }
        }

        async function handleBarcodeSearch() {
            const barcodeToSearch = el.barcodeSearchInput.value.trim();
            if (!barcodeToSearch) { el.barcodeSearchResult.textContent = "Please enter a barcode."; el.barcodeSearchResult.style.color = "var(--warning)"; return; }
            el.barcodeSearchBtn.disabled = true; el.barcodeSearchResult.textContent = "Searching..."; el.barcodeSearchResult.style.color = "var(--info)";
            try { const data = await apiCall("searchBarcode", { barcode: barcodeToSearch });
                if (data.found) { el.barcodeSearchResult.textContent = `Found in session: ${data.date}`; el.barcodeSearchResult.style.color = "var(--success)"; } 
                else { el.barcodeSearchResult.textContent = "Barcode not found in any session."; el.barcodeSearchResult.style.color = "var(--danger)"; }
            } catch (error) { el.barcodeSearchResult.textContent = "Search failed."; el.barcodeSearchResult.style.color = "var(--danger)"; } 
            finally { el.barcodeSearchBtn.disabled = false; }
        }
        
        async function handleManualSave() {
            el.manualSaveBtn.disabled = true; el.manualSaveBtnText.classList.add('hidden'); el.manualSaveBtnSpinner.classList.remove('hidden');
            try { await autoSaveSession(true); } 
            catch (error) { 
                if (error.message !== 'Offline') {
                    Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Save failed!', showConfirmButton: false, timer: 2000 }); 
                }
            } 
            finally { 
                el.manualSaveBtn.disabled = !navigator.onLine; // Re-enable only if online
                el.manualSaveBtnText.classList.remove('hidden'); el.manualSaveBtnSpinner.classList.add('hidden'); 
            }
        }
        
        async function autoSaveSession(showSuccess = false) {
            if (!navigator.onLine) {
                // If offline, just update the status without trying to save
                el.autoSaveStatus.textContent = '✗ Offline'; el.autoSaveStatus.style.color = 'var(--danger)'; el.autoSaveStatus.classList.add("show"); 
                setTimeout(() => { el.autoSaveStatus.classList.remove("show"); el.autoSaveStatus.textContent = '✓ Saved'; el.autoSaveStatus.style.color = 'var(--success)'; }, 3000);
                throw new Error("Offline");
            }
            try { 
                await apiCall("saveSession", { sessionId: currentSessionId, barcodes: scannedBarcodes });
                if (showSuccess) { Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Session saved!', showConfirmButton: false, timer: 2000 }); } 
                else { el.autoSaveStatus.classList.add("show"); setTimeout(() => { el.autoSaveStatus.classList.remove("show") }, 2000); }
            } catch (error) { 
                el.autoSaveStatus.textContent = '✗ Save Failed'; el.autoSaveStatus.style.color = 'var(--danger)'; el.autoSaveStatus.classList.add("show"); 
                setTimeout(() => { el.autoSaveStatus.classList.remove("show"); el.autoSaveStatus.textContent = '✓ Saved'; el.autoSaveStatus.style.color = 'var(--success)'; }, 3000); 
                throw error; 
            }
        }
        
        function printScannedOrder(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No items to print.",icon:"info"});document.getElementById("printDate").textContent=new Date().toLocaleString();const t=document.getElementById("printBarcodeList");t.innerHTML="";const e=[...currentlyViewingBarcodes].reverse();let a=Math.ceil(e.length/40);for(let s=0;s<a;s++){const n=e.slice(s*40,(s+1)*40),o=document.createElement("div");o.className="print-column",n.forEach((t,e)=>{const a=document.createElement("div");a.textContent=`${s*40+e+1}. ${t}`,o.appendChild(a)}),t.appendChild(o)}window.print()}
        function downloadCsv(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No items to download.",icon:"info"});const t=[...currentlyViewingBarcodes].reverse();let e="No,Barcode\n";t.forEach((t,a)=>{e+=`${a+1},"${t}"\n`});const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`scanned_order_${currentlyViewingSessionId}.csv`,s.click()}
        
        function filterSessionsByDate(){const t=el.searchByDate.value;let e=allSessions.filter(e=>e.id!==currentSessionId);t&&(e=e.filter(e=>{const a=new Date(e.createdAt).toISOString().split('T')[0];return a===t})),el.savedSessionsSelect.innerHTML=`<option value="">Select a previous session</option>`,e.sort((t,e)=>e.createdAt-t.createdAt).forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,el.savedSessionsSelect.appendChild(e)})}
        function deleteSelectedSession(){const t=el.savedSessionsSelect.value;if(!t)return void Swal.fire({title:"Please select a session to delete.",icon:"info"});Swal.fire({title:"Are you sure?",text:"This will permanently delete the selected session!",icon:"warning",showCancelButton:!0,confirmButtonColor:"var(--danger)",confirmButtonText:"Yes, delete it"}).then(e=>{e.isConfirmed&&apiCall("deleteSession",{sessionId:t}).then(()=>{Swal.fire("Deleted!","The session has been deleted.","success"),allSessions=allSessions.filter(e=>e.id!==t),filterSessionsByDate(),currentlyViewingSessionId===t&&returnToTodayView()}).catch(()=>{})})}
        function saveDataToGoogleSheet() { 
            if (scannedBarcodes.length === 0) { return Swal.fire("No Data", "There are no barcodes for today to save.", "warning"); } 
            if (!navigator.onLine) { return Swal.fire("Offline Error", "Cannot save to Google Sheet while offline.", "error"); }
            
            el.saveToSheetBtn.disabled = true; el.saveBtnText.classList.add('hidden'); el.saveBtnSpinner.classList.remove('hidden'); 
            el.sheetStatus.textContent = "Saving..."; el.sheetStatus.style.color = "var(--info)"; 
            const payload = { barcodes: [...scannedBarcodes].reverse(), sessionId: currentSessionId }; 
            
            apiCall("saveData", payload).then(() => { 
                el.sheetStatus.textContent = "Data saved successfully!"; el.sheetStatus.style.color = "var(--success)"; 
                Swal.fire("Success!", "Today's data has been saved to the daily sheet.", "success"); 
            }).catch((error) => { 
                if (error.message !== 'Offline') {
                    el.sheetStatus.textContent = "Save failed."; el.sheetStatus.style.color = "var(--danger)"; 
                } else {
                    el.sheetStatus.textContent = "Offline. Try again later."; el.sheetStatus.style.color = "var(--danger)";
                }
            }).finally(() => { 
                el.saveToSheetBtn.disabled = !navigator.onLine; // Re-enable only if online
                el.saveBtnText.classList.remove('hidden'); el.saveBtnSpinner.classList.add('hidden'); 
                setTimeout(() => { el.sheetStatus.textContent = "" }, 5000); 
            }); 
        }

        // --- Camera Scan Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            el.orderScanInput.value = decodedText; handleOrderScanAddBarcode(); stopCameraScan();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Barcode Scanned!', showConfirmButton: false, timer: 1500 });
        }
        function onScanFailure(error) { /* Do nothing to avoid console spam */ }
        function startCameraScan() {
            el.cameraModal.classList.add('show');
            if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => { Swal.fire("Camera Error", "Could not start the camera. Please check permissions.", "error"); stopCameraScan(); });
        }
        function stopCameraScan() {
            if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); }
            el.cameraModal.classList.remove('show');
        }
        
        document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>
</html>
