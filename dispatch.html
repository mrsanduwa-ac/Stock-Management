<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Out Fashion - Order Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Animate.css for Advanced Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        /* Professional & User-Friendly Color Palette */
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-card-section: #f1f3f5;
            --color-primary: #005A9C;
            --color-primary-hover: #004B80;
            --color-secondary: #6c757d;
            --text-primary: #212529;
            --border-color: #dee2e6;
            --border-focus: #80bdff;
            --danger: #d9534f;
            --danger-hover: #c9302c;
            --success: #5cb85c;
            --success-hover: #4cae4c;
            --warning: #f0ad4e;
            --warning-hover: #ec971f;
            --info: #5bc0de;
            --info-hover: #31b0d5;
        }
        
        @keyframes subtleGradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        html { height: 100%; }
        body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(-45deg, #e7f5ff, #f8f9fa, #e9ecef, #dee2e6);
            background-size: 400% 400%;
            animation: subtleGradientAnimation 30s ease infinite;
            color: var(--text-primary);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            padding: 0;
        }
        
        .main-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-grow: 1;
            width: 100%;
            padding: 1rem;
            max-width: 1200px; 
        }

        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #e9ecef; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 10px; }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 100%;
        }
        .bg-card-section { background-color: var(--bg-card-section); }
        .border-theme { border-color: var(--border-color); }

        h1, h2 { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }

        .btn { transition: background-color .2s, transform .1s, box-shadow .2s; border: none; }
        .btn:active { transform: scale(.98); }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #e9ecef; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #ced4da; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: var(--info-hover); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-warning:hover { background-color: var(--warning-hover); }
        
        /* Notification Button Styles */
        .btn-notify-on { background-color: #e6fffa; color: #047857; border: 1px solid #047857; }
        .btn-notify-off { background-color: #fff5f5; color: #c53030; border: 1px solid #c53030; animation: pulseRed 2s infinite; }
        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        input, select, textarea {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem;
        }
        input::placeholder, textarea::placeholder { color: var(--color-secondary); opacity: 0.8; }
        input:focus, select:focus, textarea:focus {
             outline: none;
             border-color: var(--border-focus);
             box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .status-message { transition: all .4s ease-in-out; opacity: 0; transform: translateY(-15px); max-height: 0; margin-top: 0; }
        .status-message.show { opacity: 1; transform: translateY(0); max-height: 100px; padding: .75rem; margin-top: .75rem; }
        .bg-green-status { background-color: #dff0d8; border: 1px solid #d6e9c6; color: #3c763d; }
        .bg-red-status { background-color: #f2dede; border: 1px solid #ebccd1; color: #a94442; }
        .auto-save-status { opacity: 0; transition: opacity .5s ease; color: var(--success); }
        .auto-save-status.show { opacity: 1; }
        
        #camera-modal { display: none; }
        #camera-modal.show { display: flex; }
        
        #recycle-bin-modal { display: none; }
        #recycle-bin-modal.show { display: flex; }

        @page { size: auto; margin: 0; }
        
        @media print {
            body { display: block; background: #fff !important; }
            .card { box-shadow: none !important; border: none !important; max-width: 100% !important; }
            body > *:not(#print-area):not(footer) { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; color: #000; }
            footer { display: none !important; }
            .no-print { display: none !important; }
            
            .print-page { position: relative; page-break-after: always; min-height: 297mm; padding: 5mm 10mm 10mm 10mm; box-sizing: border-box; }
            .print-page:last-child { page-break-after: avoid; }
            .print-header { display: block; text-align: center; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
            .print-title-group { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 5px; }
            .print-header .company-logo { height: 35px; }
            .print-header .company-name-print { font-family: 'Impact', 'Arial Narrow Bold', sans-serif; font-size: 16pt; letter-spacing: 1px; }
            .print-header .print-date { font-size: 12pt; font-weight: bold; display: block; text-align: center; }
            .print-list-container { column-count: 5; column-gap: 12px; font-size: 11pt; max-width: 100%; margin-top: 10px; }
            .print-column { break-inside: avoid; padding-right: 8px; }
            .print-column div { margin-bottom: 1px; white-space: nowrap; }
            
            .signature-area { clear: both; margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; width: 30%; margin-left: auto; font-size: 8pt; }
            .signature-area p { text-align: center; margin-top: 30px; font-size: inherit; font-weight: bold; }
            
            .print-watermark-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.25; pointer-events: none; z-index: -1; }
            .print-watermark-overlay img { width: 500px; height: auto; }
            .print-footer-watermark { position: absolute; bottom: 5mm; left: 10mm; right: 10mm; text-align: center; font-size: 8pt; color: #888; padding-top: 3px; }
        }
        @keyframes slideInFromLeft{ from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }

        .icon-online { color: var(--success); }
        .icon-offline { color: var(--danger); }
        
        @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
        .blinking-alert { animation: blink 1s step-start infinite; color: var(--danger) !important; }

        .flip-counter { height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; font-family: 'Impact', monospace; }
        .flip-digit-container { position: relative; width: 35px; height: 50px; overflow: hidden; background-color: #212529; border-radius: 4px; margin: 0 1px; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); perspective: 200px; }
        .flip-digit-container:not(:last-child):after { content: ''; position: absolute; right: -2px; top: 0; width: 1px; height: 100%; background-color: #8fbc8f; z-index: 10; }
        .flip-digit { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; color: white; backface-visibility: hidden; line-height: 1; transform: translateY(100%); }
        .flip-digit.current { transform: translateY(0%); }
        
        @keyframes flipCounterSuccessBlink { 0%, 100% { background-color: #212529; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); } 50% { background-color: var(--success); box-shadow: 0 0 10px var(--success); } }
        .flip-counter.success-blink .flip-digit-container { animation: flipCounterSuccessBlink 0.2s ease-in-out 5; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    
    <!-- Main Application Content Wrapper -->
    <div class="main-content-wrapper">
        <div id="app-container" class="card p-6 lg:p-8 rounded-2xl w-full no-print">
            <header class="flex justify-between items-center mb-6 flex-wrap gap-4 border-b border-theme pb-4">
                <div class="flex items-center gap-4">
                    <img src="logo.png" alt="Company Logo" class="h-12">
                    <h1 id="appTitle" class="text-2xl lg:text-3xl font-bold"></h1>
                </div>

                <!-- NEW: Control Center (Clock + Notify Button) -->
                <div class="flex items-center gap-4 order-3 lg:order-2">
                    <!-- Notification Button -->
                    <button id="notifyBtn" class="flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold transition-all shadow-sm" title="Click to enable notifications">
                        <span id="notifyIcon">ðŸ””</span>
                        <span id="notifyText">Check</span>
                    </button>
                    <!-- Live Clock -->
                    <div id="live-clock" class="text-lg lg:text-xl font-semibold text-secondary text-center"></div>
                </div>
            </header>
            
            <main class="flex flex-col lg:flex-row gap-8 mt-4">
                <!-- Left Column -->
                <section class="w-full lg:w-3/5 flex flex-col gap-y-6">
                    <p id="scanOrderDescription" class="text-center text-secondary -mt-2"></p>
                    
                    <div>
                         <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="orderScanInput" class="flex-grow p-3 shadow-sm" />
                            <button id="addOrderBarcodeBtn" class="px-5 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                            <button id="openCameraBtn" class="p-3 rounded-lg font-semibold shadow-md btn btn-info" aria-label="Scan with camera">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                        <div id="statusMessage" class="status-message rounded-lg text-center font-semibold p-3"></div>
                    </div>
                    <div>
                        <h2 id="scannedListHeader" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                        <div id="orderListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-60 lg:max-h-96 overflow-y-auto shadow-inner">
                            <ul id="scannedOrderBarcodesList" class="space-y-2">
                                <p id="noOrderBarcodesMessage" class="text-secondary text-center py-4"></p>
                            </ul>
                        </div>
                    </div>
                     <button id="returnToTodayBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-secondary"></button>
                </section>

                <!-- Right Column -->
                <aside class="w-full lg:w-2/5 flex flex-col gap-y-8">
                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                        <div class="mb-4">
                            <div id="connectionStatus" class="flex items-center justify-center gap-2 mb-2 p-2 rounded-lg border border-gray-300">
                                <span class="font-semibold text-sm text-secondary">Connection:</span>
                                <span id="networkIcon" class="text-xl"></span>
                                <span id="networkText" class="font-bold">Checking...</span>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center shadow-inner mt-4">
                                <p class="text-lg font-semibold text-primary mb-2" id="uniqueOrderCountLabel"></p>
                                <div id="animatedCounter" class="flex justify-center items-center h-14"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit -mt-4">
                         <h2 id="exportTitle" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                         <button id="saveToSheetBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-warning">
                            <span id="saveBtnText">Save to Google Sheet</span>
                            <div id="saveBtnSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
                         </button>
                         <p id="sheetStatus" class="text-center text-sm h-4 mt-2"></p>
                         <hr class="my-4 border-gray-300">
                         <button id="printScannedOrderBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-info"></button>
                         <button id="downloadCsvBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-success"></button>
                    </div>
                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-theme">
                            <h2 id="loadPreviousOrdersTitle" class="text-xl font-bold"></h2>
                            <span id="autoSaveStatus" class="auto-save-status font-semibold text-sm">âœ“ Saved</span>
                        </div>
                        
                        <button id="openRecycleBinBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn btn-secondary flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                            <span id="recycleBinCount">Recycle Bin (0)</span>
                        </button>

                        <div class="mb-4">
                            <label for="barcodeSearchInput" class="block mb-2 text-sm font-medium text-secondary">Search Barcode</label>
                            <div class="flex gap-2">
                                <input type="text" id="barcodeSearchInput" placeholder="Enter barcode to find..." class="w-full p-2">
                                <button id="barcodeSearchBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-info">Search</button>
                            </div>
                            <p id="barcodeSearchResult" class="text-center text-sm h-4 mt-2"></p>
                        </div>
                        <hr class="my-4 border-gray-300">
                        
                        <div id="liveSessionDisplay" class="mb-2 p-3 bg-green-100 rounded-lg text-center border border-green-200 hidden">
                            <p class="text-sm text-green-800">Live Session:</p>
                            <p id="liveSessionName" class="font-bold text-lg text-green-900"></p>
                        </div>
                        
                        <button id="manualSaveBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn btn-success text-sm">
                            <span id="manualSaveBtnText">Save Current Session</span>
                            <div id="manualSaveBtnSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>
                        </button>
                        
                        <div class="mb-4">
                             <label id="searchByDateLabel" for="searchByDate" class="block mb-2 text-sm font-medium text-secondary"></label>
                             <div class="flex gap-2">
                                <input type="date" id="searchByDate" class="w-full p-2">
                                <button id="resetDateFilterBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-secondary text-xs"></button>
                             </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <select id="savedSessionsSelect" class="flex-grow p-3"><option value=""></option></select>
                            <button id="loadSelectedSessionBtn" class="px-6 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                        </div>
                    </div>
                </aside>
            </main>
        </div>
    </div>
    
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4 text-center text-primary">Scan Barcode</h3>
            <div id="reader" width="100%"></div>
            <button id="closeCameraBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-danger">Close Camera</button>
        </div>
    </div>
    
    <div id="recycle-bin-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4 text-center text-primary flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>
                Recycle Bin
            </h3>
            <div id="recycleBinListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-80 overflow-y-auto shadow-inner">
                <ul id="recycleBinList" class="space-y-2">
                    <p id="noRecycleItems" class="text-secondary text-center py-4">Recycle bin is empty.</p>
                </ul>
            </div>
            <div class="flex gap-4 mt-4">
                 <button id="restoreSelectedBtn" class="px-5 py-2 rounded-lg font-semibold shadow-md btn btn-success flex-grow">Restore Selected</button>
                 <button id="closeRecycleBinBtn" class="px-5 py-2 rounded-lg font-semibold shadow-md btn btn-secondary flex-grow">Close</button>
            </div>
        </div>
    </div>

    <footer class="w-full p-2 text-center text-xs text-gray-500 bg-white bg-opacity-70 border-t border-gray-200 no-print">
        Â© 2025 DesignVerse by Sandusha Avishkha. All rights reserved. Crafted with passion in Minuwangoda, Sri Lanka.
    </footer>

    <div id="print-area" class="hidden"></div>

    <audio id="successSound" src="play.mp3" preload="auto"></audio>
    <audio id="errorSound" src="error.mp3" preload="auto"></audio>
    <audio id="batchAlertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        // =========================================================================
        // === YOUR GOOGLE APPS SCRIPT URL ===
        // =========================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuYsSzGAmbFUClFQEWYbPSYyDKeh3CJn8dn5yPZ4AhFxZtBseTCYurxirFRAzJ25KO/exec"; 
        // =========================================================================

        let scannedBarcodes = [];
        let currentSessionId = null;
        let currentlyViewingBarcodes = [];
        let currentlyViewingSessionId = null;
        let allSessions = [];
        let html5QrCode = null;
        
        let minuteBeepTimeout = null;
        let isBeepingActive = false;
        
        let batchTimer = null;
        const BATCH_WAIT_TIME = 10000; 
        let lastNotification = null;

        const tts = window.speechSynthesis;
        let ttsVoice = null;
        
        let recycleBin = [];
        
        function setTtsVoice() {
            const voices = tts.getVoices();
            ttsVoice = voices.find(voice => voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('girl') || voice.default && (voice.lang.startsWith('en') || voice.lang.startsWith('si'))); 
            if (!ttsVoice && voices.length > 0) {
                 ttsVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) || voices[0];
            }
        }
        
        if (tts.onvoiceschanged !== undefined) {
             tts.onvoiceschanged = setTtsVoice;
        } else {
             setTtsVoice(); 
        }
        
        const el = {
            appContainer: document.getElementById('app-container'), appTitle: document.getElementById("appTitle"), scanOrderDescription: document.getElementById("scanOrderDescription"), uniqueOrderCountLabel: document.getElementById("uniqueOrderCountLabel"), orderScanInput: document.getElementById("orderScanInput"), addOrderBarcodeBtn: document.getElementById("addOrderBarcodeBtn"), statusMessage: document.getElementById("statusMessage"), scannedListHeader: document.getElementById("scannedListHeader"), scannedOrderBarcodesList: document.getElementById("scannedOrderBarcodesList"), noOrderBarcodesMessage: document.getElementById("noOrderBarcodesMessage"), orderListContainer: document.getElementById("orderListContainer"), returnToTodayBtn: document.getElementById("returnToTodayBtn"), exportTitle: document.getElementById("exportTitle"), printScannedOrderBtn: document.getElementById("printScannedOrderBtn"), downloadCsvBtn: document.getElementById("downloadCsvBtn"), loadPreviousOrdersTitle: document.getElementById("loadPreviousOrdersTitle"), autoSaveStatus: document.getElementById("autoSaveStatus"), searchByDateLabel: document.getElementById("searchByDateLabel"), searchByDate: document.getElementById("searchByDate"), resetDateFilterBtn: document.getElementById("resetDateFilterBtn"), savedSessionsSelect: document.getElementById("savedSessionsSelect"), loadSelectedSessionBtn: document.getElementById("loadSelectedSessionBtn"), 
            liveClock: document.getElementById("live-clock"), saveToSheetBtn: document.getElementById('saveToSheetBtn'), saveBtnText: document.getElementById('saveBtnText'), saveBtnSpinner: document.getElementById('saveBtnSpinner'), sheetStatus: document.getElementById('sheetStatus'), liveSessionDisplay: document.getElementById('liveSessionDisplay'), liveSessionName: document.getElementById('liveSessionName'), manualSaveBtn: document.getElementById('manualSaveBtn'), manualSaveBtnText: document.getElementById('manualSaveBtnText'), manualSaveBtnSpinner: document.getElementById('manualSaveBtnSpinner'), barcodeSearchInput: document.getElementById('barcodeSearchInput'), barcodeSearchBtn: document.getElementById('barcodeSearchBtn'), barcodeSearchResult: document.getElementById('barcodeSearchResult'),
            cameraModal: document.getElementById('camera-modal'), openCameraBtn: document.getElementById('openCameraBtn'), closeCameraBtn: document.getElementById('closeCameraBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            networkIcon: document.getElementById('networkIcon'),
            networkText: document.getElementById('networkText'),
            animatedCounter: document.getElementById('animatedCounter'),
            printArea: document.getElementById('print-area'),
            openRecycleBinBtn: document.getElementById('openRecycleBinBtn'),
            recycleBinCount: document.getElementById('recycleBinCount'),
            recycleBinModal: document.getElementById('recycle-bin-modal'),
            closeRecycleBinBtn: document.getElementById('closeRecycleBinBtn'),
            recycleBinList: document.getElementById('recycleBinList'),
            noRecycleItems: document.getElementById('noRecycleItems'),
            restoreSelectedBtn: document.getElementById('restoreSelectedBtn'),
            batchAlertSound: document.getElementById('batchAlertSound'),
            // NEW NOTIFY BUTTON
            notifyBtn: document.getElementById('notifyBtn'),
            notifyIcon: document.getElementById('notifyIcon'),
            notifyText: document.getElementById('notifyText')
        };

        let barcodeBuffer = '';
        let barcodeTimer = null;
        const BARCODE_TIMEOUT = 50; 

        document.addEventListener('keydown', (e) => {
            if (document.activeElement === el.orderScanInput) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    setTimeout(() => handleOrderScanAddBarcode(), 50); 
                }
                return; 
            }
            const activeTag = document.activeElement.tagName;
            if (activeTag === 'INPUT' || activeTag === 'SELECT' || activeTag === 'TEXTAREA' || activeTag === 'BUTTON') {
                 return;
            }
            clearTimeout(barcodeTimer);
            if (e.key === 'Enter') {
                e.preventDefault(); 
                if (barcodeBuffer.length > 0) {
                    el.orderScanInput.value = barcodeBuffer;
                    el.orderScanInput.focus(); 
                    handleOrderScanAddBarcode();
                    barcodeBuffer = ''; 
                }
                return;
            }
            if (e.key.length === 1 && e.key.match(/[a-zA-Z0-9]/)) {
                barcodeBuffer += e.key;
                e.preventDefault(); 
                barcodeTimer = setTimeout(() => {
                    barcodeBuffer = '';
                }, BARCODE_TIMEOUT);
            }
        });
        
        const FlipCounter = {
            element: null,
            value: 0,
            digitContainers: [],
            
            initialize: function(initialValue = 0) {
                this.element = el.animatedCounter;
                this.element.classList.add('flip-counter');
                this.update(initialValue, true);
            },
            
            update: function(newValue, noAnimation = false) {
                if (newValue < 0) newValue = 0;
                const oldValueStr = String(this.value).padStart(4, '0');
                this.value = newValue;
                const newValueStr = String(newValue > 9999 ? 9999 : newValue).padStart(4, '0');
                
                while (this.digitContainers.length < 4) {
                    const container = document.createElement('div');
                    container.className = 'flip-digit-container';
                    container.innerHTML = `<div class="flip-digit current">0</div><div class="flip-digit next">0</div>`;
                    if (this.element) {
                        this.element.appendChild(container);
                    }
                    this.digitContainers.push(container);
                }

                for (let i = 0; i < 4; i++) {
                    const newDigit = newValueStr[i];
                    const oldDigit = oldValueStr[i];
                    const container = this.digitContainers[i];

                    if (newDigit !== oldDigit || noAnimation) {
                        this.animateDigit(container, oldDigit, newDigit, noAnimation);
                    }
                }
            },
            
            blinkSuccess: function() {
                el.animatedCounter.classList.add('success-blink');
                setTimeout(() => {
                    el.animatedCounter.classList.remove('success-blink');
                }, 1000); 
            },
            
            animateDigit: function(container, oldDigit, newDigit, noAnimation) {
                const currentElement = container.querySelector('.current');
                const nextElement = container.querySelector('.next');
                
                if (noAnimation) {
                    currentElement.textContent = newDigit;
                    nextElement.textContent = newDigit;
                    currentElement.style.transform = 'translateY(0%)';
                    return;
                }
                nextElement.textContent = newDigit;
                currentElement.style.transition = 'none';
                nextElement.style.transition = 'none';
                currentElement.style.transform = 'translateY(0%)';
                nextElement.style.transform = 'translateY(100%)';
                
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        currentElement.style.transition = 'transform 0.5s ease-out';
                        nextElement.style.transition = 'transform 0.5s ease-out';
                        currentElement.style.transform = 'translateY(-100%)'; 
                        nextElement.style.transform = 'translateY(0%)';      
                        setTimeout(() => {
                            currentElement.textContent = newDigit;
                            currentElement.style.transition = 'none';
                            currentElement.style.transform = 'translateY(0%)';
                            nextElement.style.transition = 'none';
                            nextElement.style.transform = 'translateY(100%)';
                        }, 500); 
                    });
                });
            }
        };

        function setInitialTexts() { 
            el.appTitle.textContent = "Order Management System"; 
            el.scanOrderDescription.textContent = "Scan order items for today's session."; 
            el.uniqueOrderCountLabel.textContent = "Total Scanned"; 
            el.addOrderBarcodeBtn.textContent = "Add"; 
            el.returnToTodayBtn.textContent = "Return to Today's Session"; 
            el.exportTitle.textContent = "Export & Save"; 
            el.printScannedOrderBtn.textContent = "Print Viewed List (A4)"; 
            el.downloadCsvBtn.textContent = "Download Viewed List (CSV)"; 
            el.loadPreviousOrdersTitle.textContent = "View Previous Sessions"; 
            el.searchByDateLabel.textContent = "Filter by Date"; 
            el.resetDateFilterBtn.textContent = "Reset"; 
            el.loadSelectedSessionBtn.textContent = "View"; 
            el.orderScanInput.placeholder = "Barcode number..."; 
            el.savedSessionsSelect.innerHTML = `<option value="">Loading...</option>`; 
            el.manualSaveBtnText.textContent = "Save Current Session"; 
        }
        
        function updateClock() { 
            const now = new Date();
            el.liveClock.textContent = now.toLocaleString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: !0 }); 
            const hour = now.getHours();
            const minute = now.getMinutes();
            const isAlertTime = (hour === 19 && minute >= 15) || (hour === 20 && minute === 0);
            
            if (isAlertTime && hour < 20) {
                el.liveClock.classList.add('blinking-alert');
                el.appTitle.classList.add('blinking-alert'); 
            } else {
                el.liveClock.classList.remove('blinking-alert');
                el.appTitle.classList.remove('blinking-alert');
            }
            updateBeepAlert(isAlertTime && hour < 20, now);
        }

        function speakTime() {
            if (!tts.speaking && ttsVoice) {
                const now = new Date();
                const hr = now.getHours() % 12 || 12;
                const min = now.getMinutes();
                const ampm = now.getHours() >= 12 ? 'P M' : 'A M';
                const timeText = `The time is ${hr} ${min === 0 ? '' : min} ${ampm}`;
                const utterance = new SpeechSynthesisUtterance(timeText);
                utterance.voice = ttsVoice;
                utterance.rate = 1.0; 
                utterance.pitch = 1.0; 
                tts.speak(utterance);
            }
        }
        
        function updateBeepAlert(isAlertTime, now) {
            if (isAlertTime && !isBeepingActive) {
                isBeepingActive = true;
                const secondsToNextMinute = 60 - now.getSeconds();
                minuteBeepTimeout = setTimeout(() => {
                    speakTime();
                    minuteBeepTimeout = setInterval(() => {
                        const current = new Date();
                        const currentHour = current.getHours();
                        if (currentHour < 20) {
                           speakTime();
                        } else {
                            clearInterval(minuteBeepTimeout);
                            isBeepingActive = false;
                        }
                    }, 60000); 
                }, secondsToNextMinute * 1000);
            } else if (!isAlertTime && isBeepingActive) {
                clearTimeout(minuteBeepTimeout);
                clearInterval(minuteBeepTimeout);
                isBeepingActive = false;
            }
        }

        function showStatusMessage(t, e) { el.statusMessage.textContent = t; el.statusMessage.className = "status-message rounded-lg text-center font-semibold p-3"; el.statusMessage.classList.add("success" === e ? "bg-green-status" : "bg-red-status", "show"); setTimeout(() => el.statusMessage.classList.remove("show"), 2500); }
        function getTodaySessionId() { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); return `SESSION-${yyyy}-${mm}-${dd}`; }
        
        async function apiCall(action, payload = {}) {
            if (!navigator.onLine && action !== 'getSessionData' && action !== 'getAllSessions') {
                 Swal.fire("Offline Error", "Cannot perform this action while offline. Please check your internet connection.", "error");
                 throw new Error("Offline");
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok && response.status !== 200) throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Unknown Google Script error.');
                }
                return data;

            } catch (error) {
                console.error(`API Call Failed for action "${action}":`, error);
                let errorMessage = error.message;
                if (error instanceof TypeError && (error.message === 'Failed to fetch' || error.message.includes('CORS'))) {
                    errorMessage = "Critical CORS/Network Error: Cannot connect to Google Script. Ensure your file is hosted on a secure server (HTTPS) and the script URL is correct. Check your browser console for details.";
                    if (action === 'getAllSessions' || action === 'getSessionData') {
                       console.error(errorMessage);
                    } else {
                       Swal.fire("Critical API Error", errorMessage, "error");
                    }
                } else if (!error.message.includes('Session not found') && error.message !== 'Offline') {
                    Swal.fire("API Error", `An error occurred while communicating with the server: ${error.message}`, "error");
                }
                throw new Error(errorMessage); 
            }
        }
        
        function loadRecycleBin() {
            try {
                const storedBin = localStorage.getItem('recycleBin');
                recycleBin = storedBin ? JSON.parse(storedBin) : [];
            } catch (e) {
                console.error("Could not load Recycle Bin from localStorage:", e);
                recycleBin = [];
            }
        }

        function saveRecycleBin() {
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                updateRecycleBinUi();
            } catch (e) {
                console.error("Could not save Recycle Bin to localStorage:", e);
            }
        }
        
        function updateRecycleBinUi() {
            el.recycleBinCount.textContent = `Recycle Bin (${recycleBin.length})`;
            el.recycleBinList.innerHTML = '';
            el.noRecycleItems.style.display = recycleBin.length > 0 ? 'none' : 'block';
            el.restoreSelectedBtn.disabled = recycleBin.length === 0;

            recycleBin.forEach((item, index) => {
                const listItem = document.createElement("li");
                listItem.className = "flex items-center justify-between p-2 rounded-md text-sm bg-white shadow-sm border border-gray-200 text-gray-700";
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = item.barcode;
                checkbox.id = `rb-item-${index}`;
                checkbox.className = 'mr-3 h-4 w-4 text-primary rounded focus:ring-primary';

                const textDiv = document.createElement('label');
                textDiv.htmlFor = `rb-item-${index}`;
                textDiv.className = 'flex-grow cursor-pointer';
                const deleteTime = new Date(item.deletedAt).toLocaleTimeString('en-US');
                textDiv.innerHTML = `
                    <span class="font-semibold">${item.barcode}</span>
                    <span class="text-xs text-secondary ml-2"> (Deleted: ${deleteTime})</span>
                `;

                listItem.appendChild(checkbox);
                listItem.appendChild(textDiv);
                el.recycleBinList.appendChild(listItem);
            });
        }
        
        function openRecycleBin() {
            loadRecycleBin();
            updateRecycleBinUi();
            el.recycleBinModal.style.display = 'flex';
        }
        
        function closeRecycleBin() {
            el.recycleBinModal.style.display = 'none';
        }

        function handleRestoreSelected() {
            const selected = Array.from(el.recycleBinList.querySelectorAll('input:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                return Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'No items selected!', showConfirmButton: false, timer: 1500 });
            }
            selected.forEach(barcode => {
                if (!scannedBarcodes.includes(barcode)) {
                    scannedBarcodes.unshift(barcode);
                }
            });
            recycleBin = recycleBin.filter(item => !selected.includes(item.barcode));
            saveRecycleBin();
            returnToTodayView(); 
            closeRecycleBin();
            autoSaveSession();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `${selected.length} item(s) restored!`, showConfirmButton: false, timer: 2000 });
        }
        
        function getWifiIcon(colorClass) {
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${colorClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.447 18.013v0c.34-.146.732-.23 1.144-.23h4.818c.412 0 .804.084 1.144.23l.115.05A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373L7.15 7.189c.34-.146.732-.23 1.144-.23h7.411c.412 0 .804.084 1.144.23l.23-.23A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373zM5 12a7 7 0 0114 0M3 18a9 9 0 0118 0" />
                </svg>
            `;
        }

        function updateNetworkStatus() {
            if (navigator.onLine) {
                el.networkIcon.innerHTML = getWifiIcon("icon-online"); 
                el.networkText.textContent = "Online";
                el.networkText.className = "font-bold text-success-hover";
                el.saveToSheetBtn.disabled = false;
                el.manualSaveBtn.disabled = false;
            } else {
                el.networkIcon.innerHTML = getWifiIcon("icon-offline"); 
                el.networkText.textContent = "Offline";
                el.networkText.className = "font-bold text-danger-hover";
                el.saveToSheetBtn.disabled = true;
                el.manualSaveBtn.disabled = true;
            }
        }

        // --- SMART ONLINE/OFFLINE ALERTS (ADVANCED) ---
        window.addEventListener('online', () => {
            updateNetworkStatus();
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Back Online! Connection restored.',
                showConfirmButton: false,
                timer: 3000,
                showClass: { popup: 'animate__animated animate__slideInRight' },
                hideClass: { popup: 'animate__animated animate__slideOutRight' }
            });
        });

        window.addEventListener('offline', () => {
            updateNetworkStatus();
            Swal.fire({
                title: 'Connection Lost!',
                text: 'You are currently offline. Please check your internet connection.',
                icon: 'warning',
                confirmButtonColor: '#d33',
                confirmButtonText: 'Okay',
                showClass: { popup: 'animate__animated animate__shakeX' }, // Shake effect
                hideClass: { popup: 'animate__animated animate__fadeOut' }
            });
        });

        function updateUiFromState() {
            const currentCount = currentlyViewingBarcodes.length;
            
            if (FlipCounter.element) {
                FlipCounter.update(currentCount); 
            }
            updateRecycleBinUi();

            el.scannedOrderBarcodesList.innerHTML = "";
            const hasBarcodes = currentCount > 0;
            const isViewingToday = currentlyViewingSessionId === currentSessionId;
            
            el.scannedListHeader.textContent = isViewingToday ? "Scanned Barcodes (Today)" : `Viewing Session: ${currentlyViewingSessionId.replace('SESSION-','')}`;
            el.noOrderBarcodesMessage.textContent = isViewingToday ? "No barcodes scanned yet for today." : "No barcodes were scanned on this day.";
            el.noOrderBarcodesMessage.style.display = hasBarcodes ? 'none' : 'block';
            el.returnToTodayBtn.style.display = isViewingToday ? 'none' : 'block';
            el.orderScanInput.disabled = !isViewingToday; el.addOrderBarcodeBtn.disabled = !isViewingToday; el.openCameraBtn.disabled = !isViewingToday;
            el.orderScanInput.placeholder = isViewingToday ? "Barcode number..." : "Viewing past session...";

            if (hasBarcodes) {
                currentlyViewingBarcodes.forEach((barcode, index) => {
                    const listItem = document.createElement("li");
                    listItem.style.animation = `slideInFromLeft 0.5s ease-out forwards`;
                    const scanNumber = currentCount - index; 
                    if(isViewingToday) {
                        listItem.className = "flex items-center justify-between p-2 rounded-md text-base bg-white shadow-sm border border-gray-200 text-gray-800";
                        const leftDiv = document.createElement('div'); leftDiv.className = 'flex items-center';
                        const numberSpan = document.createElement('span'); numberSpan.className = "font-semibold text-primary w-12 text-left"; numberSpan.textContent = `#${scanNumber}`;
                        const barcodeSpan = document.createElement('span'); barcodeSpan.textContent = barcode;
                        leftDiv.appendChild(numberSpan); leftDiv.appendChild(barcodeSpan);
                        
                        const deleteBtn = document.createElement('button'); 
                        deleteBtn.textContent = "Delete"; 
                        deleteBtn.className = "btn btn-danger px-3 py-1 text-xs rounded-md font-semibold"; 
                        deleteBtn.onclick = () => handleDeleteSingleBarcode(index); 
                        
                        listItem.appendChild(leftDiv); 
                        listItem.appendChild(deleteBtn);
                    } else {
                        listItem.className = "flex items-center p-2 text-gray-500";
                        listItem.textContent = `#${scanNumber}. ${barcode}`;
                    }
                    el.scannedOrderBarcodesList.appendChild(listItem);
                });
                el.orderListContainer.scrollTop = 0;
            }
            el.liveSessionName.textContent = `For ${currentSessionId.replace('SESSION-', '')}`;
            el.liveSessionDisplay.classList.remove('hidden');
            
            updateNetworkStatus();
            
            if (isViewingToday) {
                el.orderScanInput.focus();
            }
        }

        // --- NEW: ADVANCED NOTIFICATION LOGIC ---
        function updateNotificationUi() {
            if (Notification.permission === "granted") {
                el.notifyBtn.className = "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold transition-all shadow-sm btn-notify-on";
                el.notifyText.textContent = "On";
                el.notifyIcon.textContent = "ðŸ””";
            } else if (Notification.permission === "denied") {
                el.notifyBtn.className = "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold transition-all shadow-sm bg-gray-200 text-gray-500 border border-gray-300";
                el.notifyText.textContent = "Blocked";
                el.notifyIcon.textContent = "ðŸ”•";
            } else {
                el.notifyBtn.className = "flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold transition-all shadow-sm btn-notify-off";
                el.notifyText.textContent = "Enable";
                el.notifyIcon.textContent = "âš ï¸";
            }
        }

        function handleNotifyClick() {
            if (Notification.permission === "granted") {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Notifications are active!', showConfirmButton: false, timer: 1500 });
            } else if (Notification.permission === "denied") {
                Swal.fire("Blocked", "You have blocked notifications. Please enable them in your browser settings.", "error");
            } else {
                Notification.requestPermission().then(permission => {
                    updateNotificationUi();
                    if (permission === "granted") {
                        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Notifications Enabled!', showConfirmButton: false, timer: 1500 });
                    }
                });
            }
        }

        function requestNotifyPermission() {
            if (Notification.permission === "default") {
                Notification.requestPermission().then(updateNotificationUi);
            }
        }

        function triggerBatchAlert() {
            if(el.batchAlertSound) {
                el.batchAlertSound.play().catch(e => console.log("Audio play failed:", e));
            }

            if (Notification.permission === "granted") {
                lastNotification = new Notification("âœ… Batch Completed", {
                    body: `Total Scanned: ${scannedBarcodes.length} Items`,
                    icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png",
                    tag: "batch-alert" 
                });
            }
        }
        
        async function initializeApp() {
            setInitialTexts(); 
            FlipCounter.initialize(0); 
            updateClock(); 
            setInterval(updateClock, 1000); 
            loadRecycleBin(); 
            
            // Check Notifications on load
            updateNotificationUi();
            
            currentSessionId = getTodaySessionId(); document.title = "World Out Fashion - OMS";
            
            el.addOrderBarcodeBtn.addEventListener("click", handleOrderScanAddBarcode);
            el.returnToTodayBtn.addEventListener("click", returnToTodayView);
            el.manualSaveBtn.addEventListener("click", handleManualSave);
            el.loadSelectedSessionBtn.addEventListener("click", loadSelectedSession);
            el.searchByDate.addEventListener("input", filterSessionsByDate);
            el.resetDateFilterBtn.addEventListener("click", () => { el.searchByDate.value = ""; filterSessionsByDate(); });
            el.barcodeSearchBtn.addEventListener("click", handleBarcodeSearch);
            el.barcodeSearchInput.addEventListener("keypress", (e) => { if (e.key === 'Enter') handleBarcodeSearch(); }); 
            el.saveToSheetBtn.addEventListener("click", saveDataToGoogleSheet);
            el.printScannedOrderBtn.addEventListener("click", printScannedOrder);
            el.downloadCsvBtn.addEventListener("click", downloadCsv);
            el.openCameraBtn.addEventListener("click", startCameraScan);
            el.closeCameraBtn.addEventListener("click", stopCameraScan);
            
            el.openRecycleBinBtn.addEventListener("click", openRecycleBin);
            el.closeRecycleBinBtn.addEventListener("click", closeRecycleBin);
            el.restoreSelectedBtn.addEventListener("click", handleRestoreSelected);
            
            // Notification Button Listener
            el.notifyBtn.addEventListener("click", handleNotifyClick);

            updateNetworkStatus(); 
            
            await reloadTodaysData();
            
            try { 
                el.savedSessionsSelect.innerHTML = `<option value="">Loading previous sessions...</option>`;
                const data = await apiCall("getAllSessions"); 
                allSessions = data.sessions; 
                filterSessionsByDate(); 
            } catch (error) { 
                console.warn("Could not load previous sessions:", error.message);
                el.savedSessionsSelect.innerHTML = `<option value="">Failed to load sessions (API Error)</option>`;
            }
            
            el.orderScanInput.focus();
        }
        
        async function reloadTodaysData() {
             try { 
                 const data = await apiCall("getSessionData", { sessionId: currentSessionId }); 
                 scannedBarcodes = data.session.data.barcodes || []; 
             } 
             catch (error) { 
                 if (error.message.includes('Session not found')) { 
                     scannedBarcodes = []; 
                 } else {
                     scannedBarcodes = [];
                     console.error("Failed to load today's session data due to API error:", error.message);
                 }
             }
            returnToTodayView();
        }
        
        function handleOrderScanAddBarcode() {
            if (Notification.permission === "default") {
                requestNotifyPermission();
            }

            if (lastNotification) lastNotification.close();
            clearTimeout(batchTimer);

            const barcode = el.orderScanInput.value.trim();
            if (barcode === "") return;
            if (scannedBarcodes.includes(barcode)) {
                showStatusMessage(`Already Scanned: ${barcode}`, "error");
                const errorAudio = document.getElementById('errorSound');
                if (errorAudio) { errorAudio.pause(); errorAudio.currentTime = 0; errorAudio.play().catch(console.error); }
            } else {
                scannedBarcodes.unshift(barcode); 
                currentlyViewingBarcodes = scannedBarcodes;
                showStatusMessage(`Success: ${barcode}`, "success");
                const successAudio = document.getElementById('successSound');
                if (successAudio) { successAudio.pause(); successAudio.currentTime = 0; successAudio.play().catch(console.error); }
                updateUiFromState();
                autoSaveSession();
            }
            el.orderScanInput.value = "";
            el.orderScanInput.focus();

            batchTimer = setTimeout(triggerBatchAlert, BATCH_WAIT_TIME);
        }
        
        function handleDeleteSingleBarcode(indexToDelete) {
            const barcodeToDelete = currentlyViewingBarcodes[indexToDelete];
            Swal.fire({ 
                title: 'Are you sure?', 
                text: `Move barcode: ${barcodeToDelete} to Recycle Bin?`, 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonColor: 'var(--danger)', 
                confirmButtonText: 'Yes, Move to Bin!', 
                cancelButtonText: 'Cancel'
            }).then((result) => { 
                if (result.isConfirmed) { 
                    recycleBin.push({
                        barcode: barcodeToDelete,
                        deletedAt: new Date().toISOString()
                    });
                    saveRecycleBin(); 
                    scannedBarcodes.splice(indexToDelete, 1); 
                    currentlyViewingBarcodes = [...scannedBarcodes]; 
                    updateUiFromState(); 
                    autoSaveSession(); 
                    Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Item moved to Recycle Bin!', showConfirmButton: false, timer: 2000 });
                } 
            });
        }
        
        function returnToTodayView() {
            currentlyViewingSessionId = currentSessionId; currentlyViewingBarcodes = [...scannedBarcodes]; updateUiFromState();
        }
        
        async function loadSelectedSession() {
            const sessionId = el.savedSessionsSelect.value;
            if (!sessionId) { return Swal.fire({ title: "Please select a session to view.", icon: 'info' }); }
            el.loadSelectedSessionBtn.disabled = true; el.loadSelectedSessionBtn.textContent = "Loading...";
            
            try { 
                const data = await apiCall("getSessionData", { sessionId: sessionId }); 
                currentlyViewingSessionId = sessionId; 
                currentlyViewingBarcodes = data.session.data.barcodes || []; 
                updateUiFromState(); 
            } catch (error) { 
                console.error("Failed to load selected session:", error.message);
                 if (!error.message.includes('Session not found')) {
                     Swal.fire("Load Error", `Could not load session data: ${error.message}. Returning to today's view.`, "error");
                 }
                returnToTodayView(); 
            } finally { 
                el.loadSelectedSessionBtn.disabled = false; 
                el.loadSelectedSessionBtn.textContent = "View"; 
            }
        }

        async function handleBarcodeSearch() {
            const barcodeToSearch = el.barcodeSearchInput.value.trim();
            if (!barcodeToSearch) { el.barcodeSearchResult.textContent = "Please enter a barcode."; el.barcodeSearchResult.style.color = "var(--warning)"; return; }
            el.barcodeSearchBtn.disabled = true; el.barcodeSearchResult.textContent = "Searching..."; el.barcodeSearchResult.style.color = "var(--info)";
            try { const data = await apiCall("searchBarcode", { barcode: barcodeToSearch });
                if (data.found) { el.barcodeSearchResult.textContent = `Found in session: ${data.date}`; el.barcodeSearchResult.style.color = "var(--success)"; } 
                else { el.barcodeSearchResult.textContent = "Barcode not found in any session."; el.barcodeSearchResult.style.color = "var(--danger)"; }
            } catch (error) { el.barcodeSearchResult.textContent = "Search failed."; el.barcodeSearchResult.style.color = "var(--danger)"; } 
            finally { el.barcodeSearchBtn.disabled = false; }
        }
        
        async function handleManualSave() {
            el.manualSaveBtn.disabled = true; el.manualSaveBtnText.classList.add('hidden'); el.manualSaveBtnSpinner.classList.remove('hidden');
            try { await autoSaveSession(true); } 
            catch (error) { } 
            finally { 
                el.manualSaveBtn.disabled = !navigator.onLine; 
                el.manualSaveBtnText.classList.remove('hidden'); el.manualSaveBtnSpinner.classList.add('hidden'); 
            }
        }
        
        async function autoSaveSession(isManual = false) {
            if (!navigator.onLine) {
                el.autoSaveStatus.textContent = 'âœ— Offline'; 
                el.autoSaveStatus.style.color = 'var(--danger)'; 
                el.autoSaveStatus.classList.add("show"); 
                setTimeout(() => { 
                    el.autoSaveStatus.classList.remove("show"); 
                    el.autoSaveStatus.textContent = 'âœ“ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                }, 3000);
                return;
            }
            try { 
                await apiCall("saveSession", { sessionId: currentSessionId, barcodes: scannedBarcodes });
                FlipCounter.blinkSuccess();
                if (isManual) { 
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Session saved!', showConfirmButton: false, timer: 2000 }); 
                } else { 
                    el.autoSaveStatus.classList.remove("show"); 
                    el.autoSaveStatus.textContent = 'âœ“ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                    el.autoSaveStatus.classList.add("show"); 
                    setTimeout(() => { el.autoSaveStatus.classList.remove("show") }, 2000); 
                }
            } catch (error) { 
                el.autoSaveStatus.textContent = 'âœ— Save Failed'; 
                el.autoSaveStatus.style.color = 'var(--danger)'; 
                el.autoSaveStatus.classList.add("show"); 
                setTimeout(() => { 
                    el.autoSaveStatus.classList.remove("show"); 
                    el.autoSaveStatus.textContent = 'âœ“ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                }, 3000); 
            }
        }
        
        function printScannedOrder() {
            const barcodes = currentlyViewingBarcodes;
            if (barcodes.length === 0) {
                return Swal.fire({ title: "No items to print.", icon: "info" });
            }
            const itemsToPrint = [...barcodes].reverse(); 
            const totalItems = itemsToPrint.length;
            const maxItemsPerColumn = 40;
            const columnsPerPage = 5;
            const maxItemsPerPage = maxItemsPerColumn * columnsPerPage; 
            el.printArea.innerHTML = ""; 

            let pageHtml = "";
            let itemIndex = 0;
            let pageNumber = 1;

            const generatePageHeader = (page) => `
                <div class="print-page">
                    <div class="print-watermark-overlay">
                        <img src="logo.png" alt="Watermark Logo">
                    </div>
                    <div class="print-header">
                        <div class="print-title-group">
                            <img src="logo.png" alt="Company Logo" class="company-logo">
                            <h1 class="company-name-print">World Out Fashion</h1>
                        </div>
                        <p class="print-date">Date: ${new Date().toLocaleString('en-US')}</p>
                    </div>
                    <div class="print-list-container">
            `;
            const generateSignatureArea = () => `
                <div class="signature-area">
                    <p style="text-align: center; margin-top: 0; margin-bottom: 5px; font-weight: normal;">Signature:</p>
                    <p style="border-top: 1px solid #000; padding-top: 5px;">Prepared By</p>
                </div>
            `;
            const generatePageFooter = () => `
                    </div>
                    <div class="print-footer-watermark">
                        Â© 2025 DesignVerse by Sandusha Avishkha. All rights reserved. Crafted with passion in Minuwangoda, Sri Lanka.
                    </div>
                </div>
            `;
            
            while (itemIndex < totalItems) {
                const isLastPage = (totalItems - itemIndex) <= maxItemsPerPage;
                const itemsForThisPage = Math.min(totalItems - itemIndex, maxItemsPerPage);
                pageHtml += generatePageHeader(pageNumber);
                let contentHtml = '';
                const maxIndexForPage = itemIndex + itemsForThisPage;
                for (let col = 0; col < columnsPerPage; col++) {
                    const startColIndex = itemIndex + col * maxItemsPerColumn;
                    if (startColIndex < maxIndexForPage) {
                        contentHtml += '<div class="print-column">';
                        const endColIndex = Math.min(startColIndex + maxItemsPerColumn, maxIndexForPage);
                        for (let i = startColIndex; i < endColIndex; i++) {
                            const itemNumber = i + 1;
                            contentHtml += `<div>${itemNumber}. ${itemsToPrint[i]}</div>`;
                        }
                        contentHtml += '</div>';
                    }
                }
                pageHtml += contentHtml;
                if (isLastPage) {
                    pageHtml += generateSignatureArea();
                } 
                pageHtml += generatePageFooter();
                itemIndex = maxIndexForPage; 
                pageNumber++;
            }
            el.printArea.innerHTML = pageHtml;
            window.print();
        }
        
        function downloadCsv(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No items to download.",icon:"info"});const t=[...currentlyViewingBarcodes].reverse();let e="No,Barcode\n";t.forEach((t,a)=>{e+=`${a+1},"${t}"\n`});const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`scanned_order_${currentlyViewingSessionId}.csv`,s.click()}
        
        function filterSessionsByDate(){const t=el.searchByDate.value;let e=allSessions.filter(e=>e.id!==currentSessionId);t&&(e=e.filter(e=>{const a=new Date(e.createdAt).toISOString().split('T')[0];return a===t})),el.savedSessionsSelect.innerHTML=`<option value="">Select a previous session</option>`,e.sort((t,e)=>e.createdAt-t.createdAt).forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,el.savedSessionsSelect.appendChild(e)})}
        
        function saveDataToGoogleSheet() { 
            if (scannedBarcodes.length === 0) { return Swal.fire("No Data", "There are no barcodes for today to save.", "warning"); } 
            if (!navigator.onLine) { return Swal.fire("Offline Error", "Cannot save to Google Sheet while offline.", "error"); }
            
            el.saveToSheetBtn.disabled = true; el.saveBtnText.classList.add('hidden'); el.saveBtnSpinner.classList.remove('hidden'); 
            el.sheetStatus.textContent = "Saving..."; el.sheetStatus.style.color = "var(--info)"; 
            const payload = { barcodes: [...scannedBarcodes].reverse(), sessionId: currentSessionId }; 
            
            apiCall("saveData", payload).then(() => { 
                el.sheetStatus.textContent = "Data saved successfully!"; el.sheetStatus.style.color = "var(--success)"; 
                Swal.fire("Success!", "Today's data has been saved to the daily sheet.", "success"); 
            }).catch((error) => { 
                if (error.message !== 'Offline') {
                    el.sheetStatus.textContent = "Save failed."; el.sheetStatus.style.color = "var(--danger)"; 
                } else {
                    el.sheetStatus.textContent = "Offline. Try again later."; el.sheetStatus.style.color = "var(--danger)";
                }
            }).finally(() => { 
                el.saveToSheetBtn.disabled = !navigator.onLine; 
                el.saveBtnText.classList.remove('hidden'); el.saveBtnSpinner.classList.add('hidden'); 
                setTimeout(() => { el.sheetStatus.textContent = "" }, 5000); 
            }); 
        }

        function onScanSuccess(decodedText, decodedResult) {
            el.orderScanInput.value = decodedText; 
            handleOrderScanAddBarcode(); 
            stopCameraScan();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Barcode Scanned!', showConfirmButton: false, timer: 1500 });
            el.orderScanInput.focus(); 
        }
        function onScanFailure(error) { /* Do nothing */ }
        function startCameraScan() {
            el.cameraModal.classList.add('show');
            if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            el.orderScanInput.value = ""; 
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => { Swal.fire("Camera Error", "Could not start the camera. Please check permissions.", "error"); stopCameraScan(); });
        }
        function stopCameraScan() {
            if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); }
            el.cameraModal.classList.remove('show');
            el.orderScanInput.focus(); 
        }
        
        document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>
</html>
