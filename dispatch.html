<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Out Fashion - Order Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Professional & User-Friendly Color Palette */
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-card-section: #f1f3f5;
            --color-primary: #005A9C; /* A professional, deep blue */
            --color-primary-hover: #004B80;
            --color-secondary: #6c757d; /* Muted gray for secondary text */
            --text-primary: #212529; /* Dark charcoal for primary text */
            --border-color: #dee2e6;
            --border-focus: #80bdff;
            --danger: #d9534f;
            --danger-hover: #c9302c;
            --success: #5cb85c;
            --success-hover: #4cae4c;
            --warning: #f0ad4e;
            --warning-hover: #ec971f;
            --info: #5bc0de;
            --info-hover: #31b0d5;
        }
        
        /* Background Animation Keyframes */
        @keyframes subtleGradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* General Styles */
        html { height: 100%; }
        body {
            /* Centering the container */
            display: flex;
            flex-direction: column; /* Allow footer to attach to the bottom */
            justify-content: space-between;
            align-items: center;
            min-height: 100vh;
            
            /* Animated Background */
            background: linear-gradient(-45deg, #e7f5ff, #f8f9fa, #e9ecef, #dee2e6);
            background-size: 400% 400%;
            animation: subtleGradientAnimation 30s ease infinite;

            color: var(--text-primary);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            padding: 0; /* Remove default body padding */
        }
        
        .main-content-wrapper {
            /* Ensures main app card takes up most space and stays centered */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-grow: 1;
            width: 100%;
            padding: 1rem; /* p-4 */
            max-width: 1200px; 
        }

        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #e9ecef; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 10px; }

        /* Card and Container Styles */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            width: 100%;
        }
        .bg-card-section {
            background-color: var(--bg-card-section);
        }
        .border-theme {
            border-color: var(--border-color);
        }

        /* Text and Headers */
        h1, h2 { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }

        /* Buttons */
        .btn { transition: background-color .2s, transform .1s, box-shadow .2s; border: none; }
        .btn:active { transform: scale(.98); }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #e9ecef; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #ced4da; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: var(--info-hover); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-warning:hover { background-color: var(--warning-hover); }

        /* Inputs and Forms */
        input, select, textarea {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-lg */
        }
        input::placeholder, textarea::placeholder { color: var(--color-secondary); opacity: 0.8; }
        input:focus, select:focus, textarea:focus {
             outline: none;
             border-color: var(--border-focus);
             box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        /* Status Messages */
        .status-message { transition: all .4s ease-in-out; opacity: 0; transform: translateY(-15px); max-height: 0; margin-top: 0; }
        .status-message.show { opacity: 1; transform: translateY(0); max-height: 100px; padding: .75rem; margin-top: .75rem; }
        .bg-green-status { background-color: #dff0d8; border: 1px solid #d6e9c6; color: #3c763d; }
        .bg-red-status { background-color: #f2dede; border: 1px solid #ebccd1; color: #a94442; }
        .auto-save-status { opacity: 0; transition: opacity .5s ease; color: var(--success); }
        .auto-save-status.show { opacity: 1; }
        
        /* Camera Modal */
        #camera-modal { display: none; }
        #camera-modal.show { display: flex; }
        
        /* Recycle Bin Modal */
        #recycle-bin-modal { display: none; }
        #recycle-bin-modal.show { display: flex; }

        /* Print Styles */
        /* --- CRITICAL: Remove URL/Page Numbers/Margins added by browser --- */
        @page { 
            size: auto; 
            margin: 0; /* Remove default browser print margin */
        }
        
        @media print {
            body { 
                display: block; /* Override flex for printing */
                background: #fff !important; 
            }
            .card {
                box-shadow: none !important;
                border: none !important;
                max-width: 100% !important;
            }
            /* Hide everything except the print area */
            body > *:not(#print-area):not(footer) { display: none !important; }
            
            #print-area { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                padding: 0; /* Page content padding is inside print-page */
                box-sizing: border-box; 
                font-family: 'Arial', sans-serif; 
                color: #000; 
            }
            
            /* Hide the main footer during print */
            footer { display: none !important; }

            .no-print { display: none !important; }
            
            /* --- Custom Print Styles for Barcode Layout --- */
            .print-page {
                position: relative; /* For the watermark */
                page-break-after: always;
                /* Maximize space within print margins (A4 is 297mm high) */
                min-height: 297mm; 
                padding: 5mm 10mm 10mm 10mm; /* Reduced top/bottom padding for more space */
                box-sizing: border-box;
            }
            .print-page:last-child {
                page-break-after: avoid;
            }
            
            .print-header { 
                /* NEW: Change to block and text-align center */
                display: block; 
                text-align: center;
                border-bottom: 2px solid #333; 
                padding-bottom: 5px; 
                margin-bottom: 5px; /* Reduced header margin */
            }
            .print-title-group { 
                /* NEW: Center the logo and name group */
                display: flex; 
                justify-content: center; /* Center the group */
                align-items: center; 
                gap: 15px; 
                margin-bottom: 5px; 
            }
            .print-header .company-logo { height: 35px; /* Slightly smaller logo */ }
            .print-header .company-name-print { font-family: 'Impact', 'Arial Narrow Bold', sans-serif; font-size: 16pt; /* Slightly smaller font */ letter-spacing: 1px; }
            .print-header .print-date { 
                /* NEW: Center the date/time */
                font-size: 9pt; /* Smaller date font */
                font-weight: bold; 
                display: block; 
                text-align: center;
            }
            
            .print-list-container {
                column-count: 5; 
                column-gap: 12px; /* Reduced column gap */
                font-size: 8.5pt; /* Smaller list font */
                max-width: 100%;
                margin-top: 10px;
            }

            .print-column { 
                break-inside: avoid; 
                padding-right: 8px; /* Reduced padding */
            }
            .print-column div { 
                margin-bottom: 1px; /* CRITICAL: Reduced to 1px for maximum fit */
                white-space: nowrap; 
            }
            
            /* --- Signature Area --- */
            .signature-area {
                clear: both; 
                margin-top: 30px; /* Reduced top margin */
                padding-top: 10px;
                border-top: 1px solid #ccc;
                width: 30%; 
                margin-left: auto; 
                font-size: 8pt; /* Smaller signature font */
            }
            .signature-area p {
                text-align: center;
                margin-top: 30px; /* Reduced space for the signature */
                font-size: inherit;
                font-weight: bold;
            }
            
            /* --- Print Watermark --- */
            .print-watermark-overlay {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                opacity: 0.25; 
                pointer-events: none;
                z-index: -1;
            }
            .print-watermark-overlay img {
                width: 300px; 
                height: auto;
            }
            
            /* --- Print Footer Watermark (The required text) --- */
            .print-footer-watermark {
                position: absolute;
                /* Attach to the bottom of the content area within the page padding */
                bottom: 5mm; 
                left: 10mm;
                right: 10mm;
                text-align: center;
                font-size: 7pt;
                color: #888;
                /* Remove border as per user's image, only necessary for separation */
                /* border-top: 1px solid #eee; */
                padding-top: 3px;
            }
        }
        @keyframes slideInFromLeft{ from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }

        /* Custom SVG Icon Styling */
        .icon-online { color: var(--success); }
        .icon-offline { color: var(--danger); }
        
        /* NEW: Blinking Effect for Time Alert */
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        .blinking-alert {
            animation: blink 1s step-start infinite;
            color: var(--danger) !important; 
        }

        /* NEW: Flip Counter Styles based on image */
        .flip-counter {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: 'Impact', monospace; /* Use monospaced font for digits */
        }
        .flip-digit-container {
            position: relative;
            width: 35px; /* Wider digits */
            height: 50px; 
            overflow: hidden;
            background-color: #212529; /* Dark background matching the image */
            border-radius: 4px;
            margin: 0 1px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            perspective: 200px; /* For potential 3D flip effect */
        }
        /* Style for the light green separator, applied only between digits */
        .flip-digit-container:not(:last-child):after {
             content: '';
             position: absolute;
             right: -2px; /* Position separator slightly outside the digit box */
             top: 0;
             width: 1px;
             height: 100%;
             background-color: #8fbc8f; /* Light green separator color from image */
             z-index: 10;
        }
        .flip-digit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white; /* White digits from image */
            backface-visibility: hidden;
            line-height: 1;
            /* Initial state of the 'next' digit, pushed down */
            transform: translateY(100%);
        }
        /* Ensure the current digit starts visible */
        .flip-digit.current {
            transform: translateY(0%);
        }
        
        /* NEW: Flip Counter Blinking Animation (on auto-save success) */
        @keyframes flipCounterSuccessBlink {
            0%, 100% { background-color: #212529; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); }
            50% { background-color: var(--success); box-shadow: 0 0 10px var(--success); }
        }
        .flip-counter.success-blink .flip-digit-container {
             /* 5 blinks over 1 second (0.2s * 5) */
             animation: flipCounterSuccessBlink 0.2s ease-in-out 5; 
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    
    <!-- Main Application Content Wrapper -->
    <div class="main-content-wrapper">
        <div id="app-container" class="card p-6 lg:p-8 rounded-2xl w-full no-print">
            <header class="flex justify-between items-center mb-6 flex-wrap gap-4 border-b border-theme pb-4">
                <div class="flex items-center gap-4">
                    <img src="logo.png" alt="Company Logo" class="h-12">
                    <h1 id="appTitle" class="text-2xl lg:text-3xl font-bold"></h1>
                </div>
                <div id="live-clock" class="text-lg lg:text-xl font-semibold text-secondary order-3 lg:order-2 w-full lg:w-auto text-center"></div>
            </header>
            
            <main class="flex flex-col lg:flex-row gap-8 mt-4">
                <!-- Left Column -->
                <section class="w-full lg:w-3/5 flex flex-col gap-y-6">
                    <p id="scanOrderDescription" class="text-center text-secondary -mt-2"></p>
                    
                    <div>
                         <div class="flex flex-col sm:flex-row gap-2">
                            <!-- Input will gain focus from scanner or number pad entry -->
                            <input type="text" id="orderScanInput" class="flex-grow p-3 shadow-sm" />
                            <button id="addOrderBarcodeBtn" class="px-5 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                            <button id="openCameraBtn" class="p-3 rounded-lg font-semibold shadow-md btn btn-info" aria-label="Scan with camera">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                        <div id="statusMessage" class="status-message rounded-lg text-center font-semibold p-3"></div>
                    </div>
                    <div>
                        <h2 id="scannedListHeader" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                        <div id="orderListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-60 lg:max-h-96 overflow-y-auto shadow-inner">
                            <ul id="scannedOrderBarcodesList" class="space-y-2">
                                <p id="noOrderBarcodesMessage" class="text-secondary text-center py-4"></p>
                            </ul>
                        </div>
                    </div>
                     <button id="returnToTodayBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-secondary"></button>
                </section>

                <!-- Right Column -->
                <aside class="w-full lg:w-2/5 flex flex-col gap-y-8">
                    <!-- Network Status Display and Animated Counter -->
                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                        <div class="mb-4">
                            <!-- Connection Status -->
                            <div id="connectionStatus" class="flex items-center justify-center gap-2 mb-2 p-2 rounded-lg border border-gray-300">
                                <span class="font-semibold text-sm text-secondary">Connection:</span>
                                <!-- Icon and Text will be updated by JavaScript -->
                                <span id="networkIcon" class="text-xl"></span>
                                <span id="networkText" class="font-bold">Checking...</span>
                            </div>

                            <!-- NEW: Animated Barcode Count Display -->
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center shadow-inner mt-4">
                                <p class="text-lg font-semibold text-primary mb-2" id="uniqueOrderCountLabel"></p>
                                <div id="animatedCounter" class="flex justify-center items-center h-14">
                                    <!-- Digits will be added here by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit -mt-4">
                         <h2 id="exportTitle" class="text-xl font-bold mb-4 border-b-2 border-theme pb-2"></h2>
                         <button id="saveToSheetBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-warning">
                            <span id="saveBtnText">Save to Google Sheet</span>
                            <div id="saveBtnSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
                         </button>
                         <p id="sheetStatus" class="text-center text-sm h-4 mt-2"></p>
                         <hr class="my-4 border-gray-300">
                         <button id="printScannedOrderBtn" class="w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-info"></button>
                         <button id="downloadCsvBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-success"></button>
                    </div>
                    <div class="p-6 bg-card-section rounded-xl border border-theme shadow-inner h-fit">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-theme">
                            <h2 id="loadPreviousOrdersTitle" class="text-xl font-bold"></h2>
                            <!-- This status changes color for errors (red) or shows success (green) -->
                            <span id="autoSaveStatus" class="auto-save-status font-semibold text-sm">✓ Saved</span>
                        </div>
                        
                        <!-- NEW: Recycle Bin Button -->
                        <button id="openRecycleBinBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn btn-secondary flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                            <span id="recycleBinCount">Recycle Bin (0)</span>
                        </button>

                        <div class="mb-4">
                            <label for="barcodeSearchInput" class="block mb-2 text-sm font-medium text-secondary">Search Barcode</label>
                            <div class="flex gap-2">
                                <input type="text" id="barcodeSearchInput" placeholder="Enter barcode to find..." class="w-full p-2">
                                <button id="barcodeSearchBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-info">Search</button>
                            </div>
                            <p id="barcodeSearchResult" class="text-center text-sm h-4 mt-2"></p>
                        </div>
                        <hr class="my-4 border-gray-300">
                        
                        <div id="liveSessionDisplay" class="mb-2 p-3 bg-green-100 rounded-lg text-center border border-green-200 hidden">
                            <p class="text-sm text-green-800">Live Session:</p>
                            <p id="liveSessionName" class="font-bold text-lg text-green-900"></p>
                        </div>
                        
                        <button id="manualSaveBtn" class="w-full mb-4 px-6 py-2 rounded-lg font-semibold shadow-md btn btn-success text-sm">
                            <span id="manualSaveBtnText">Save Current Session</span>
                            <div id="manualSaveBtnSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>
                        </button>
                        
                        <div class="mb-4">
                             <label id="searchByDateLabel" for="searchByDate" class="block mb-2 text-sm font-medium text-secondary"></label>
                             <div class="flex gap-2">
                                <input type="date" id="searchByDate" class="w-full p-2">
                                <button id="resetDateFilterBtn" class="px-4 py-2 rounded-lg font-semibold shadow-md btn btn-secondary text-xs"></button>
                             </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <select id="savedSessionsSelect" class="flex-grow p-3"><option value=""></option></select>
                            <button id="loadSelectedSessionBtn" class="px-6 py-3 rounded-lg font-semibold shadow-md btn btn-primary"></button>
                        </div>
                        <button id="deleteSelectedSessionBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-danger"></button>
                    </div>
                </aside>
            </main>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4 text-center text-primary">Scan Barcode</h3>
            <div id="reader" width="100%"></div>
            <button id="closeCameraBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold shadow-md btn btn-danger">Close Camera</button>
        </div>
    </div>
    
    <!-- NEW: Recycle Bin Modal -->
    <div id="recycle-bin-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4 text-center text-primary flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>
                Recycle Bin
            </h3>
            <div id="recycleBinListContainer" class="bg-card-section p-4 rounded-lg border border-theme max-h-80 overflow-y-auto shadow-inner">
                <ul id="recycleBinList" class="space-y-2">
                    <p id="noRecycleItems" class="text-secondary text-center py-4">Recycle bin is empty.</p>
                </ul>
            </div>
            <div class="flex gap-4 mt-4">
                 <button id="restoreSelectedBtn" class="px-5 py-2 rounded-lg font-semibold shadow-md btn btn-success flex-grow">Restore Selected</button>
                 <button id="closeRecycleBinBtn" class="px-5 py-2 rounded-lg font-semibold shadow-md btn btn-secondary flex-grow">Close</button>
            </div>
        </div>
    </div>

    <!-- NEW: Web Application Footer Watermark -->
    <footer class="w-full p-2 text-center text-xs text-gray-500 bg-white bg-opacity-70 border-t border-gray-200 no-print">
        © 2025 DesignVerse by Sandusha Avishkha. All rights reserved. Crafted with passion in Minuwangoda, Sri Lanka.
    </footer>

    <!-- PRINT AREA (Hidden in UI) -->
    <div id="print-area" class="hidden">
        <!-- Print content will be generated here by JavaScript -->
    </div>

    <!-- Local audio files as per original request -->
    <audio id="successSound" src="play.mp3" preload="auto"></audio>
    <audio id="errorSound" src="error.mp3" preload="auto"></audio>

    <script>
        // =========================================================================
        // === වැදගත්: මෙතනට ඔබගේ Google Apps Script URL එක ඇතුළත් කරන්න ===
        // =========================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuYsSzGAmbFUClFQEWYbPSYyDKeh3CJn8dn5yPZ4AhFxZtBseTCYurxirFRAzJ25KO/exec"; 
        // =========================================================================

        let scannedBarcodes = [];
        let currentSessionId = null;
        let currentlyViewingBarcodes = [];
        let currentlyViewingSessionId = null;
        let allSessions = [];
        let html5QrCode = null;
        
        // Time Alert Variables
        let minuteBeepTimeout = null;
        let isBeepingActive = false;
        
        // NEW: TTS Object and Voice Setup
        const tts = window.speechSynthesis;
        let ttsVoice = null;
        
        // NEW: Recycle Bin Storage
        let recycleBin = [];
        
        // --- TTS Voice Setup (Find a female voice) ---
        function setTtsVoice() {
            const voices = tts.getVoices();
            // Try to find a female voice using common keywords (sinhala is not supported, so using english/default female if available)
            ttsVoice = voices.find(voice => voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('girl') || voice.default && (voice.lang.startsWith('en') || voice.lang.startsWith('si'))); 
            // Fallback to the first available voice if none found
            if (!ttsVoice && voices.length > 0) {
                 // Trying to select a common English voice as a fallback
                 ttsVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) || voices[0];
            }
        }
        
        // Load voices once they are available
        if (tts.onvoiceschanged !== undefined) {
             tts.onvoiceschanged = setTtsVoice;
        } else {
             setTtsVoice(); // Fallback for browsers that fire immediately
        }
        
        const el = {
            appContainer: document.getElementById('app-container'), appTitle: document.getElementById("appTitle"), scanOrderDescription: document.getElementById("scanOrderDescription"), uniqueOrderCountLabel: document.getElementById("uniqueOrderCountLabel"), orderScanInput: document.getElementById("orderScanInput"), addOrderBarcodeBtn: document.getElementById("addOrderBarcodeBtn"), statusMessage: document.getElementById("statusMessage"), scannedListHeader: document.getElementById("scannedListHeader"), scannedOrderBarcodesList: document.getElementById("scannedOrderBarcodesList"), noOrderBarcodesMessage: document.getElementById("noOrderBarcodesMessage"), orderListContainer: document.getElementById("orderListContainer"), returnToTodayBtn: document.getElementById("returnToTodayBtn"), exportTitle: document.getElementById("exportTitle"), printScannedOrderBtn: document.getElementById("printScannedOrderBtn"), downloadCsvBtn: document.getElementById("downloadCsvBtn"), loadPreviousOrdersTitle: document.getElementById("loadPreviousOrdersTitle"), autoSaveStatus: document.getElementById("autoSaveStatus"), searchByDateLabel: document.getElementById("searchByDateLabel"), searchByDate: document.getElementById("searchByDate"), resetDateFilterBtn: document.getElementById("resetDateFilterBtn"), savedSessionsSelect: document.getElementById("savedSessionsSelect"), loadSelectedSessionBtn: document.getElementById("loadSelectedSessionBtn"), deleteSelectedSessionBtn: document.getElementById("deleteSelectedSessionBtn"), liveClock: document.getElementById("live-clock"), saveToSheetBtn: document.getElementById('saveToSheetBtn'), saveBtnText: document.getElementById('saveBtnText'), saveBtnSpinner: document.getElementById('saveBtnSpinner'), sheetStatus: document.getElementById('sheetStatus'), liveSessionDisplay: document.getElementById('liveSessionDisplay'), liveSessionName: document.getElementById('liveSessionName'), manualSaveBtn: document.getElementById('manualSaveBtn'), manualSaveBtnText: document.getElementById('manualSaveBtnText'), manualSaveBtnSpinner: document.getElementById('manualSaveBtnSpinner'), barcodeSearchInput: document.getElementById('barcodeSearchInput'), barcodeSearchBtn: document.getElementById('barcodeSearchBtn'), barcodeSearchResult: document.getElementById('barcodeSearchResult'),
            cameraModal: document.getElementById('camera-modal'), openCameraBtn: document.getElementById('openCameraBtn'), closeCameraBtn: document.getElementById('closeCameraBtn'),
            // Network Status Elements
            connectionStatus: document.getElementById('connectionStatus'),
            networkIcon: document.getElementById('networkIcon'),
            networkText: document.getElementById('networkText'),
            // Animated Counter Element
            animatedCounter: document.getElementById('animatedCounter'),
            printArea: document.getElementById('print-area'),
            // NEW: Recycle Bin Elements
            openRecycleBinBtn: document.getElementById('openRecycleBinBtn'),
            recycleBinCount: document.getElementById('recycleBinCount'),
            recycleBinModal: document.getElementById('recycle-bin-modal'),
            closeRecycleBinBtn: document.getElementById('closeRecycleBinBtn'),
            recycleBinList: document.getElementById('recycleBinList'),
            noRecycleItems: document.getElementById('noRecycleItems'),
            restoreSelectedBtn: document.getElementById('restoreSelectedBtn'),
        };

        // --- NEW: ANIMATED FLIP COUNTER LOGIC ---
        const FlipCounter = {
            element: null,
            value: 0,
            digitContainers: [],
            
            initialize: function(initialValue = 0) {
                this.element = el.animatedCounter;
                this.element.classList.add('flip-counter');
                this.update(initialValue, true);
            },
            
            update: function(newValue, noAnimation = false) {
                if (newValue < 0) newValue = 0;
                // Pad up to 4 digits for a consistent display (max 9999 orders)
                const oldValueStr = String(this.value).padStart(4, '0');
                this.value = newValue;
                const newValueStr = String(newValue > 9999 ? 9999 : newValue).padStart(4, '0'); // Limit to 9999
                
                // Ensure there are 4 digit containers
                while (this.digitContainers.length < 4) {
                    const container = document.createElement('div');
                    container.className = 'flip-digit-container';
                    // Inside container: two layers, one for current, one for next
                    container.innerHTML = `<div class="flip-digit current">0</div><div class="flip-digit next">0</div>`;
                    // FIX: Ensure 'this.element' exists before appending
                    if (this.element) {
                        this.element.appendChild(container);
                    }
                    this.digitContainers.push(container);
                }

                for (let i = 0; i < 4; i++) {
                    const newDigit = newValueStr[i];
                    const oldDigit = oldValueStr[i];
                    const container = this.digitContainers[i];

                    if (newDigit !== oldDigit || noAnimation) {
                        this.animateDigit(container, oldDigit, newDigit, noAnimation);
                    }
                }
            },
            
            // NEW: Success Blink Effect
            blinkSuccess: function() {
                el.animatedCounter.classList.add('success-blink');
                // The animation lasts 1 second (0.2s * 5 iterations in CSS), so we remove the class after that
                setTimeout(() => {
                    el.animatedCounter.classList.remove('success-blink');
                }, 1000); 
            },
            
            animateDigit: function(container, oldDigit, newDigit, noAnimation) {
                const currentElement = container.querySelector('.current');
                const nextElement = container.querySelector('.next');
                
                if (noAnimation) {
                    currentElement.textContent = newDigit;
                    nextElement.textContent = newDigit;
                    currentElement.style.transform = 'translateY(0%)';
                    return;
                }

                // 1. Initial State Setup
                nextElement.textContent = newDigit;
                
                // Reset positions (instant, no transition)
                currentElement.style.transition = 'none';
                nextElement.style.transition = 'none';
                currentElement.style.transform = 'translateY(0%)';
                nextElement.style.transform = 'translateY(100%)';
                
                // 2. Start Animation (after reflow/delay)
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        currentElement.style.transition = 'transform 0.5s ease-out';
                        nextElement.style.transition = 'transform 0.5s ease-out';

                        currentElement.style.transform = 'translateY(-100%)'; // Move current digit up
                        nextElement.style.transform = 'translateY(0%)';      // Move next digit up to replace
                        
                        // 3. Final State (Swap content and reset for next animation)
                        setTimeout(() => {
                            // Set the final state immediately after the transition ends
                            currentElement.textContent = newDigit;
                            
                            // Reset position by instantly moving back to 0% after animation
                            currentElement.style.transition = 'none';
                            currentElement.style.transform = 'translateY(0%)';
                            nextElement.style.transition = 'none';
                            nextElement.style.transform = 'translateY(100%)';
                            
                        }, 500); // Match CSS transition duration
                    });
                });
            }
        };


        // --- CORE & HELPER FUNCTIONS ---
        function setInitialTexts() { 
            el.appTitle.textContent = "Order Management System"; 
            el.scanOrderDescription.textContent = "Scan order items for today's session."; 
            el.uniqueOrderCountLabel.textContent = "Total Scanned"; 
            el.addOrderBarcodeBtn.textContent = "Add"; 
            el.returnToTodayBtn.textContent = "Return to Today's Session"; 
            el.exportTitle.textContent = "Export & Save"; 
            el.printScannedOrderBtn.textContent = "Print Viewed List (A4)"; 
            el.downloadCsvBtn.textContent = "Download Viewed List (CSV)"; 
            el.loadPreviousOrdersTitle.textContent = "View Previous Sessions"; 
            el.searchByDateLabel.textContent = "Filter by Date"; 
            el.resetDateFilterBtn.textContent = "Reset"; 
            el.loadSelectedSessionBtn.textContent = "View"; 
            el.deleteSelectedSessionBtn.textContent = "Delete"; 
            el.orderScanInput.placeholder = "Barcode number..."; 
            el.savedSessionsSelect.innerHTML = `<option value="">Loading...</option>`; 
            el.manualSaveBtnText.textContent = "Save Current Session"; 
        }
        
        function updateClock() { 
            const now = new Date();
            el.liveClock.textContent = now.toLocaleString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: !0 }); 
            
            // NEW: Blinking Logic (7:15 PM to 8:00 PM local time)
            const hour = now.getHours();
            const minute = now.getMinutes();

            // Check if time is between 19:15:00 and 20:00:00 (exclusive of 20:00:00)
            const isAlertTime = (hour === 19 && minute >= 15) || (hour === 20 && minute === 0);
            
            if (isAlertTime && hour < 20) {
                el.liveClock.classList.add('blinking-alert');
                el.appTitle.classList.add('blinking-alert'); 
            } else {
                el.liveClock.classList.remove('blinking-alert');
                el.appTitle.classList.remove('blinking-alert');
            }
            
            // Check if TTS system needs to be started or stopped
            updateBeepAlert(isAlertTime && hour < 20, now);
        }

        // NEW: Time Announcement Logic (Replaces the Beep Sound)
        function speakTime() {
            // Check if speech is already running or if voice is unavailable
            if (!tts.speaking && ttsVoice) {
                const now = new Date();
                const hr = now.getHours() % 12 || 12;
                const min = now.getMinutes();
                const ampm = now.getHours() >= 12 ? 'P M' : 'A M';
                const timeText = `The time is ${hr} ${min === 0 ? '' : min} ${ampm}`;
                
                const utterance = new SpeechSynthesisUtterance(timeText);
                utterance.voice = ttsVoice;
                utterance.rate = 1.0; 
                utterance.pitch = 1.0; 
                tts.speak(utterance);
            }
        }
        
        function updateBeepAlert(isAlertTime, now) {
            if (isAlertTime && !isBeepingActive) {
                // START Announcement
                isBeepingActive = true;
                
                // Calculate time until the next minute start
                const secondsToNextMinute = 60 - now.getSeconds();
                
                // Set the initial announcement after the calculated time
                minuteBeepTimeout = setTimeout(() => {
                    speakTime();
                    
                    // Set up interval for subsequent announcements (every 60 seconds)
                    minuteBeepTimeout = setInterval(() => {
                        const current = new Date();
                        const currentHour = current.getHours();
                        // Check time again before speaking to ensure we don't speak at exactly 20:00:00
                        if (currentHour < 20) {
                           speakTime();
                        } else {
                            // Stop Announcement when the window closes (at 20:00:00)
                            clearInterval(minuteBeepTimeout);
                            isBeepingActive = false;
                        }
                    }, 60000); // 60 seconds
                    
                }, secondsToNextMinute * 1000);

            } else if (!isAlertTime && isBeepingActive) {
                // STOP Announcement (If outside the window but interval is still running)
                clearTimeout(minuteBeepTimeout);
                clearInterval(minuteBeepTimeout);
                isBeepingActive = false;
            }
        }

        function showStatusMessage(t, e) { el.statusMessage.textContent = t; el.statusMessage.className = "status-message rounded-lg text-center font-semibold p-3"; el.statusMessage.classList.add("success" === e ? "bg-green-status" : "bg-red-status", "show"); setTimeout(() => el.statusMessage.classList.remove("show"), 2500); }
        function getTodaySessionId() { const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); return `SESSION-${yyyy}-${mm}-${dd}`; }
        
        // --- API COMMUNICATION ---
       async function apiCall(action, payload = {}) {
            // Check network status before making an API call
            if (!navigator.onLine && action !== 'getSessionData' && action !== 'getAllSessions') {
                 Swal.fire("Offline Error", "Cannot perform this action while offline. Please check your internet connection.", "error");
                 throw new Error("Offline");
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...payload })
                });
                
                // Check for network errors that aren't caught by fetch but may indicate CORS issues
                if (!response.ok && response.status !== 200) throw new Error(`Network response error: ${response.status} ${response.statusText}`);

                // Attempt to read JSON, even if the status is not ok (GAS often returns errors as JSON)
                const data = await response.json();
                
                if (data.status !== 'success') {
                    // This handles custom errors sent by the Google Script
                    throw new Error(data.message || 'Unknown Google Script error.');
                }
                return data;

            } catch (error) {
                console.error(`API Call Failed for action "${action}":`, error);
                
                let errorMessage = error.message;
                
                // Handle the CORS/Network error specifically shown in your console
                if (error instanceof TypeError && (error.message === 'Failed to fetch' || error.message.includes('CORS'))) {
                    errorMessage = "Critical CORS/Network Error: Cannot connect to Google Script. Ensure your file is hosted on a secure server (HTTPS) and the script URL is correct. Check your browser console for details.";
                    // Only show this critical error once on initial failure for session loading
                    if (action === 'getAllSessions' || action === 'getSessionData') {
                       // Do not show Swal here, let the caller function handle the initial UI error message
                       console.error(errorMessage);
                    } else {
                       // Show Swal for user-triggered actions (save, delete, etc.)
                       Swal.fire("Critical API Error", errorMessage, "error");
                    }
                } else if (!error.message.includes('Session not found') && error.message !== 'Offline') {
                    // Existing error handling for non-critical errors
                    Swal.fire("API Error", `An error occurred while communicating with the server: ${error.message}`, "error");
                }
                
                throw new Error(errorMessage); 
            }
        }
        
        // --- RECYCLE BIN LOGIC (using Local Storage) ---
        function loadRecycleBin() {
            try {
                const storedBin = localStorage.getItem('recycleBin');
                recycleBin = storedBin ? JSON.parse(storedBin) : [];
            } catch (e) {
                console.error("Could not load Recycle Bin from localStorage:", e);
                recycleBin = [];
            }
        }

        function saveRecycleBin() {
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                updateRecycleBinUi();
            } catch (e) {
                console.error("Could not save Recycle Bin to localStorage:", e);
            }
        }
        
        function updateRecycleBinUi() {
            el.recycleBinCount.textContent = `Recycle Bin (${recycleBin.length})`;
            el.recycleBinList.innerHTML = '';
            el.noRecycleItems.style.display = recycleBin.length > 0 ? 'none' : 'block';
            el.restoreSelectedBtn.disabled = recycleBin.length === 0;

            recycleBin.forEach((item, index) => {
                const listItem = document.createElement("li");
                listItem.className = "flex items-center justify-between p-2 rounded-md text-sm bg-white shadow-sm border border-gray-200 text-gray-700";
                
                // Checkbox for selection
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = item.barcode;
                checkbox.id = `rb-item-${index}`;
                checkbox.className = 'mr-3 h-4 w-4 text-primary rounded focus:ring-primary';

                // Barcode text and deletion time
                const textDiv = document.createElement('label');
                textDiv.htmlFor = `rb-item-${index}`;
                textDiv.className = 'flex-grow cursor-pointer';
                const deleteTime = new Date(item.deletedAt).toLocaleTimeString('en-US');
                textDiv.innerHTML = `
                    <span class="font-semibold">${item.barcode}</span>
                    <span class="text-xs text-secondary ml-2"> (Deleted: ${deleteTime})</span>
                `;

                listItem.appendChild(checkbox);
                listItem.appendChild(textDiv);
                el.recycleBinList.appendChild(listItem);
            });
        }
        
        function openRecycleBin() {
            loadRecycleBin();
            updateRecycleBinUi();
            el.recycleBinModal.style.display = 'flex';
        }
        
        function closeRecycleBin() {
            el.recycleBinModal.style.display = 'none';
        }

        function handleRestoreSelected() {
            const selected = Array.from(el.recycleBinList.querySelectorAll('input:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                return Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'No items selected!', showConfirmButton: false, timer: 1500 });
            }

            // Move items back to scannedBarcodes (at the top, newest first)
            selected.forEach(barcode => {
                if (!scannedBarcodes.includes(barcode)) {
                    scannedBarcodes.unshift(barcode);
                }
            });
            
            // Remove restored items from recycleBin
            recycleBin = recycleBin.filter(item => !selected.includes(item.barcode));
            saveRecycleBin();
            
            // Update the main UI
            returnToTodayView(); 
            closeRecycleBin();
            autoSaveSession();
            
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `${selected.length} item(s) restored!`, showConfirmButton: false, timer: 2000 });
        }
        
        // --- NETWORK STATUS LOGIC ---
        function getWifiIcon(colorClass) {
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${colorClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.447 18.013v0c.34-.146.732-.23 1.144-.23h4.818c.412 0 .804.084 1.144.23l.115.05A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373L7.15 7.189c.34-.146.732-.23 1.144-.23h7.411c.412 0 .804.084 1.144.23l.23-.23A7.994 7.994 0 0012 4a7.994 7.994 0 00-5.679 2.373zM5 12a7 7 0 0114 0M3 18a9 9 0 0118 0" />
                </svg>
            `;
        }

        function updateNetworkStatus() {
            if (navigator.onLine) {
                el.networkIcon.innerHTML = getWifiIcon("icon-online"); 
                el.networkText.textContent = "Online";
                el.networkText.className = "font-bold text-success-hover";
            } else {
                el.networkIcon.innerHTML = getWifiIcon("icon-offline"); 
                el.networkText.textContent = "Offline";
                el.networkText.className = "font-bold text-danger-hover";
                if(el.networkText.textContent !== "Offline") {
                     Swal.fire("Offline Mode", "The application is currently offline. Data saving to Google Sheet is disabled.", "warning");
                }
            }
            el.saveToSheetBtn.disabled = !navigator.onLine;
            el.manualSaveBtn.disabled = !navigator.onLine;
        }

        // --- UI & STATE MANAGEMENT ---
        function updateUiFromState() {
            const currentCount = currentlyViewingBarcodes.length;
            
            if (FlipCounter.element) {
                FlipCounter.update(currentCount); 
            }
            updateRecycleBinUi();

            el.scannedOrderBarcodesList.innerHTML = "";
            const hasBarcodes = currentCount > 0;
            const isViewingToday = currentlyViewingSessionId === currentSessionId;
            
            el.scannedListHeader.textContent = isViewingToday ? "Scanned Barcodes (Today)" : `Viewing Session: ${currentlyViewingSessionId.replace('SESSION-','')}`;
            el.noOrderBarcodesMessage.textContent = isViewingToday ? "No barcodes scanned yet for today." : "No barcodes were scanned on this day.";
            el.noOrderBarcodesMessage.style.display = hasBarcodes ? 'none' : 'block';
            el.returnToTodayBtn.style.display = isViewingToday ? 'none' : 'block';
            el.orderScanInput.disabled = !isViewingToday; el.addOrderBarcodeBtn.disabled = !isViewingToday; el.openCameraBtn.disabled = !isViewingToday;
            el.orderScanInput.placeholder = isViewingToday ? "Barcode number..." : "Viewing past session...";

            if (hasBarcodes) {
                // Barcodes are stored in reverse order (newest first). Display them in reverse (newest at top) but number them 1-based (newest is #1)
                currentlyViewingBarcodes.forEach((barcode, index) => {
                    const listItem = document.createElement("li");
                    listItem.style.animation = `slideInFromLeft 0.5s ease-out forwards`;
                    // Calculate scan number based on current length - index (since it's newest first)
                    const scanNumber = currentCount - index; 
                    if(isViewingToday) {
                        listItem.className = "flex items-center justify-between p-2 rounded-md text-base bg-white shadow-sm border border-gray-200 text-gray-800";
                        const leftDiv = document.createElement('div'); leftDiv.className = 'flex items-center';
                        const numberSpan = document.createElement('span'); numberSpan.className = "font-semibold text-primary w-12 text-left"; numberSpan.textContent = `#${scanNumber}`;
                        const barcodeSpan = document.createElement('span'); barcodeSpan.textContent = barcode;
                        leftDiv.appendChild(numberSpan); leftDiv.appendChild(barcodeSpan);
                        
                        // Pass the actual index in the currentlyViewingBarcodes array (which is scannedBarcodes)
                        const deleteBtn = document.createElement('button'); 
                        deleteBtn.textContent = "Delete"; 
                        deleteBtn.className = "btn btn-danger px-3 py-1 text-xs rounded-md font-semibold"; 
                        deleteBtn.onclick = () => handleDeleteSingleBarcode(index); 
                        
                        listItem.appendChild(leftDiv); 
                        listItem.appendChild(deleteBtn);
                    } else {
                        listItem.className = "flex items-center p-2 text-gray-500";
                        listItem.textContent = `#${scanNumber}. ${barcode}`;
                    }
                    el.scannedOrderBarcodesList.appendChild(listItem);
                });
                el.orderListContainer.scrollTop = 0;
            }
            el.liveSessionName.textContent = `For ${currentSessionId.replace('SESSION-', '')}`;
            el.liveSessionDisplay.classList.remove('hidden');
            
            updateNetworkStatus();
            
            // NEW: Ensure input is focused after UI update
            if (isViewingToday) {
                el.orderScanInput.focus();
            }
        }
        
        // --- APPLICATION LOGIC ---
        async function initializeApp() {
            setInitialTexts(); 
            
            FlipCounter.initialize(0); 
            
            updateClock(); 
            setInterval(updateClock, 1000); 

            // Load recycle bin at startup
            loadRecycleBin(); 
            
            currentSessionId = getTodaySessionId(); document.title = "World Out Fashion - OMS";
            
            // NEW: Handle input from any keyboard (including numeric keypad)
            document.addEventListener("keyup", (e) => {
                // If a key is pressed while the input is not focused and the key is a relevant scan character
                if (document.activeElement !== el.orderScanInput && e.key.length === 1 && (e.key.match(/[a-zA-Z0-9]/) || e.code.startsWith('Numpad'))) {
                    el.orderScanInput.focus();
                }
            });
            
            el.orderScanInput.addEventListener("keypress", (e) => { 
                // Only process Enter key to submit the barcode
                if (e.key === 'Enter') {
                    handleOrderScanAddBarcode(); 
                } 
            });
            
            el.addOrderBarcodeBtn.addEventListener("click", handleOrderScanAddBarcode);
            el.returnToTodayBtn.addEventListener("click", returnToTodayView);
            el.manualSaveBtn.addEventListener("click", handleManualSave);
            el.loadSelectedSessionBtn.addEventListener("click", loadSelectedSession);
            el.deleteSelectedSessionBtn.addEventListener("click", deleteSelectedSession);
            el.searchByDate.addEventListener("input", filterSessionsByDate);
            el.resetDateFilterBtn.addEventListener("click", () => { el.searchByDate.value = ""; filterSessionsByDate(); });
            el.barcodeSearchBtn.addEventListener("click", handleBarcodeSearch);
            el.barcodeSearchInput.addEventListener("keypress", (e) => { if (e.key === 'Enter') handleBarcodeSearch(); });
            el.saveToSheetBtn.addEventListener("click", saveDataToGoogleSheet);
            el.printScannedOrderBtn.addEventListener("click", printScannedOrder);
            el.downloadCsvBtn.addEventListener("click", downloadCsv);
            el.openCameraBtn.addEventListener("click", startCameraScan);
            el.closeCameraBtn.addEventListener("click", stopCameraScan);
            
            // NEW Recycle Bin Listeners
            el.openRecycleBinBtn.addEventListener("click", openRecycleBin);
            el.closeRecycleBinBtn.addEventListener("click", closeRecycleBin);
            el.restoreSelectedBtn.addEventListener("click", handleRestoreSelected);


            // Network Initialization
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus(); 
            
            await reloadTodaysData();
            
            // --- NEW FIX: Changed how getAllSessions is called to better handle initial errors ---
            try { 
                el.savedSessionsSelect.innerHTML = `<option value="">Loading previous sessions...</option>`;
                const data = await apiCall("getAllSessions"); 
                allSessions = data.sessions; 
                filterSessionsByDate(); 
            } catch (error) { 
                console.warn("Could not load previous sessions:", error.message);
                el.savedSessionsSelect.innerHTML = `<option value="">Failed to load sessions (API Error)</option>`;
            }
            
            el.orderScanInput.focus();
        }
        
        async function reloadTodaysData() {
             try { 
                 const data = await apiCall("getSessionData", { sessionId: currentSessionId }); 
                 scannedBarcodes = data.session.data.barcodes || []; 
             } 
             catch (error) { 
                 if (error.message.includes('Session not found')) { 
                     scannedBarcodes = []; 
                 } else {
                     // NEW FIX: If there's an API error loading today's data, initialize with empty array
                     scannedBarcodes = [];
                     console.error("Failed to load today's session data due to API error:", error.message);
                 }
             }
            returnToTodayView();
        }
        
        function handleOrderScanAddBarcode() {
            const barcode = el.orderScanInput.value.trim();
            if (barcode === "") return;
            if (scannedBarcodes.includes(barcode)) {
                showStatusMessage(`Already Scanned: ${barcode}`, "error");
                const errorAudio = document.getElementById('errorSound');
                if (errorAudio) { errorAudio.pause(); errorAudio.currentTime = 0; errorAudio.play().catch(console.error); }
            } else {
                // Add to the front of the array (unshift) so the newest is always index 0
                scannedBarcodes.unshift(barcode); 
                currentlyViewingBarcodes = scannedBarcodes;
                showStatusMessage(`Success: ${barcode}`, "success");
                const successAudio = document.getElementById('successSound');
                if (successAudio) { successAudio.pause(); successAudio.currentTime = 0; successAudio.play().catch(console.error); }
                updateUiFromState();
                autoSaveSession();
            }
            el.orderScanInput.value = "";
            el.orderScanInput.focus();
        }
        
        function handleDeleteSingleBarcode(indexToDelete) {
            // Index is the direct index in the currentlyViewingBarcodes array (which is scannedBarcodes)
            const barcodeToDelete = currentlyViewingBarcodes[indexToDelete];
            
            Swal.fire({ 
                title: 'Are you sure?', 
                text: `Move barcode: ${barcodeToDelete} to Recycle Bin?`, 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonColor: 'var(--danger)', 
                confirmButtonText: 'Yes, Move to Bin!', 
                cancelButtonText: 'Cancel'
            }).then((result) => { 
                if (result.isConfirmed) { 
                    
                    // 1. Add to Recycle Bin
                    recycleBin.push({
                        barcode: barcodeToDelete,
                        deletedAt: new Date().toISOString()
                    });
                    saveRecycleBin(); 

                    // 2. Delete from the main array
                    scannedBarcodes.splice(indexToDelete, 1); 
                    currentlyViewingBarcodes = [...scannedBarcodes]; 
                    
                    // 3. Update UI and AutoSave
                    updateUiFromState(); 
                    autoSaveSession(); 
                    
                    // 4. Show Side Notification (Toast)
                    Swal.fire({ 
                        toast: true, 
                        position: 'top-end', 
                        icon: 'info', 
                        title: 'Item moved to Recycle Bin!', 
                        showConfirmButton: false, 
                        timer: 2000
                    });
                } 
            });
        }
        
        function returnToTodayView() {
            currentlyViewingSessionId = currentSessionId; currentlyViewingBarcodes = [...scannedBarcodes]; updateUiFromState();
        }
        
        async function loadSelectedSession() {
            const sessionId = el.savedSessionsSelect.value;
            if (!sessionId) { return Swal.fire({ title: "Please select a session to view.", icon: 'info' }); }
            el.loadSelectedSessionBtn.disabled = true; el.loadSelectedSessionBtn.textContent = "Loading...";
            
            // --- NEW FIX: Improved error handling for load selected session ---
            try { 
                const data = await apiCall("getSessionData", { sessionId: sessionId }); 
                currentlyViewingSessionId = sessionId; 
                currentlyViewingBarcodes = data.session.data.barcodes || []; 
                updateUiFromState(); 
            } catch (error) { 
                console.error("Failed to load selected session:", error.message);
                // Inform user only if it's not a 'session not found' error
                 if (!error.message.includes('Session not found')) {
                     Swal.fire("Load Error", `Could not load session data: ${error.message}. Returning to today's view.`, "error");
                 }
                returnToTodayView(); 
            } finally { 
                el.loadSelectedSessionBtn.disabled = false; 
                el.loadSelectedSessionBtn.textContent = "View"; 
            }
        }

        async function handleBarcodeSearch() {
            const barcodeToSearch = el.barcodeSearchInput.value.trim();
            if (!barcodeToSearch) { el.barcodeSearchResult.textContent = "Please enter a barcode."; el.barcodeSearchResult.style.color = "var(--warning)"; return; }
            el.barcodeSearchBtn.disabled = true; el.barcodeSearchResult.textContent = "Searching..."; el.barcodeSearchResult.style.color = "var(--info)";
            try { const data = await apiCall("searchBarcode", { barcode: barcodeToSearch });
                if (data.found) { el.barcodeSearchResult.textContent = `Found in session: ${data.date}`; el.barcodeSearchResult.style.color = "var(--success)"; } 
                else { el.barcodeSearchResult.textContent = "Barcode not found in any session."; el.barcodeSearchResult.style.color = "var(--danger)"; }
            } catch (error) { el.barcodeSearchResult.textContent = "Search failed."; el.barcodeSearchResult.style.color = "var(--danger)"; } 
            finally { el.barcodeSearchBtn.disabled = false; }
        }
        
        async function handleManualSave() {
            el.manualSaveBtn.disabled = true; el.manualSaveBtnText.classList.add('hidden'); el.manualSaveBtnSpinner.classList.remove('hidden');
            try { await autoSaveSession(true); } 
            catch (error) { 
                // Error handling is done inside autoSaveSession now
            } 
            finally { 
                el.manualSaveBtn.disabled = !navigator.onLine; 
                el.manualSaveBtnText.classList.remove('hidden'); el.manualSaveBtnSpinner.classList.add('hidden'); 
            }
        }
        
        async function autoSaveSession(isManual = false) {
            if (!navigator.onLine) {
                // If offline, just update the status without trying to save
                el.autoSaveStatus.textContent = '✗ Offline'; 
                el.autoSaveStatus.style.color = 'var(--danger)'; 
                el.autoSaveStatus.classList.add("show"); 
                // Set to success color on clear for visual continuity (3 seconds)
                setTimeout(() => { 
                    el.autoSaveStatus.classList.remove("show"); 
                    el.autoSaveStatus.textContent = '✓ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                }, 3000);
                return;
            }
            try { 
                await apiCall("saveSession", { sessionId: currentSessionId, barcodes: scannedBarcodes });
                
                // NEW: Trigger Flip Counter Blink
                FlipCounter.blinkSuccess();
                
                if (isManual) { 
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Session saved!', showConfirmButton: false, timer: 2000 }); 
                } else { 
                    // Show auto-save success status briefly (2 seconds)
                    el.autoSaveStatus.classList.remove("show"); // Ensure class is removed first
                    el.autoSaveStatus.textContent = '✓ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                    el.autoSaveStatus.classList.add("show"); 
                    setTimeout(() => { el.autoSaveStatus.classList.remove("show") }, 2000); 
                }
            } catch (error) { 
                // NEW: Error Status Update (3 seconds)
                el.autoSaveStatus.textContent = '✗ Save Failed'; 
                el.autoSaveStatus.style.color = 'var(--danger)'; 
                el.autoSaveStatus.classList.add("show"); 
                // Set to success color on clear for visual continuity
                setTimeout(() => { 
                    el.autoSaveStatus.classList.remove("show"); 
                    el.autoSaveStatus.textContent = '✓ Saved'; 
                    el.autoSaveStatus.style.color = 'var(--success)'; 
                }, 3000); 
            }
        }
        
        function printScannedOrder() {
            const barcodes = currentlyViewingBarcodes;
            if (barcodes.length === 0) {
                return Swal.fire({ title: "No items to print.", icon: "info" });
            }

            // The list is stored newest first, but print should be oldest first (#1, #2, ...)
            const itemsToPrint = [...barcodes].reverse(); 
            const totalItems = itemsToPrint.length;
            
            // Print constants
            const maxItemsPerColumn = 40;
            const columnsPerPage = 5;
            const maxItemsPerPage = maxItemsPerColumn * columnsPerPage; // 200 items per page
            
            el.printArea.innerHTML = ""; // Clear existing print area

            let pageHtml = "";
            let itemIndex = 0;
            let pageNumber = 1;

            const generatePageHeader = (page) => `
                <div class="print-page">
                    <div class="print-watermark-overlay">
                        <img src="logo.png" alt="Watermark Logo">
                    </div>
                    <div class="print-header">
                        <div class="print-title-group">
                            <img src="logo.png" alt="Company Logo" class="company-logo">
                            <h1 class="company-name-print">World Out Fashion</h1>
                        </div>
                        <p class="print-date">Date: ${new Date().toLocaleString('en-US')}</p>
                    </div>
                    <div class="print-list-container">
            `;
            
            const generateSignatureArea = () => `
                <div class="signature-area">
                    <p style="text-align: center; margin-top: 0; margin-bottom: 5px; font-weight: normal;">Signature:</p>
                    <p style="border-top: 1px solid #000; padding-top: 5px;">Prepared By</p>
                </div>
            `;
            
            const generatePageFooter = () => `
                    </div> <!-- Close print-list-container -->
                    <div class="print-footer-watermark">
                        © 2025 DesignVerse by Sandusha Avishkha. All rights reserved. Crafted with passion in Minuwangoda, Sri Lanka.
                    </div>
                </div>
            `;
            
            // Loop through all pages
            while (itemIndex < totalItems) {
                const isLastPage = (totalItems - itemIndex) <= maxItemsPerPage;
                const itemsForThisPage = Math.min(totalItems - itemIndex, maxItemsPerPage);
                
                pageHtml += generatePageHeader(pageNumber);
                let contentHtml = '';
                
                // Determine the maximum item index for the current page
                const maxIndexForPage = itemIndex + itemsForThisPage;
                
                // Loop through columns
                for (let col = 0; col < columnsPerPage; col++) {
                    const startColIndex = itemIndex + col * maxItemsPerColumn;
                    
                    // Only start a column if there are items for it
                    if (startColIndex < maxIndexForPage) {
                        contentHtml += '<div class="print-column">';
                        
                        // Determine the end index for this column
                        const endColIndex = Math.min(startColIndex + maxItemsPerColumn, maxIndexForPage);
                        
                        // Loop through items in this column
                        for (let i = startColIndex; i < endColIndex; i++) {
                            const itemNumber = i + 1;
                            contentHtml += `<div>${itemNumber}. ${itemsToPrint[i]}</div>`;
                        }
                        
                        contentHtml += '</div>';
                    }
                }
                
                pageHtml += contentHtml;
                
                // Add signature area only on the last page.
                // The print logic already ensures page breaks occur exactly at 200 items unless totalItems < 200.
                if (isLastPage) {
                    pageHtml += generateSignatureArea();
                } 
                
                pageHtml += generatePageFooter();
                
                // Move to the next page chunk (max 200 items/page)
                itemIndex = maxIndexForPage; 
                pageNumber++;
            }
            
            el.printArea.innerHTML = pageHtml;
            window.print();
        }
        
        function downloadCsv(){if(0===currentlyViewingBarcodes.length)return void Swal.fire({title:"No items to download.",icon:"info"});const t=[...currentlyViewingBarcodes].reverse();let e="No,Barcode\n";t.forEach((t,a)=>{e+=`${a+1},"${t}"\n`});const a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download=`scanned_order_${currentlyViewingSessionId}.csv`,s.click()}
        
        function filterSessionsByDate(){const t=el.searchByDate.value;let e=allSessions.filter(e=>e.id!==currentSessionId);t&&(e=e.filter(e=>{const a=new Date(e.createdAt).toISOString().split('T')[0];return a===t})),el.savedSessionsSelect.innerHTML=`<option value="">Select a previous session</option>`,e.sort((t,e)=>e.createdAt-t.createdAt).forEach(t=>{const e=document.createElement("option");e.value=t.id,e.textContent=t.name,el.savedSessionsSelect.appendChild(e)})}
        function deleteSelectedSession(){const t=el.savedSessionsSelect.value;if(!t)return void Swal.fire({title:"Please select a session to delete.",icon:"info"});Swal.fire({title:"Are you sure?",text:"This will permanently delete the selected session!",icon:"warning",showCancelButton:!0,confirmButtonColor:"var(--danger)",confirmButtonText:"Yes, delete it"}).then(e=>{e.isConfirmed&&apiCall("deleteSession",{sessionId:t}).then(()=>{Swal.fire("Deleted!","The session has been deleted.","success"),allSessions=allSessions.filter(e=>e.id!==t),filterSessionsByDate(),currentlyViewingSessionId===t&&returnToTodayView()}).catch(()=>{})})}
        function saveDataToGoogleSheet() { 
            if (scannedBarcodes.length === 0) { return Swal.fire("No Data", "There are no barcodes for today to save.", "warning"); } 
            if (!navigator.onLine) { return Swal.fire("Offline Error", "Cannot save to Google Sheet while offline.", "error"); }
            
            el.saveToSheetBtn.disabled = true; el.saveBtnText.classList.add('hidden'); el.saveBtnSpinner.classList.remove('hidden'); 
            el.sheetStatus.textContent = "Saving..."; el.sheetStatus.style.color = "var(--info)"; 
            const payload = { barcodes: [...scannedBarcodes].reverse(), sessionId: currentSessionId }; 
            
            apiCall("saveData", payload).then(() => { 
                el.sheetStatus.textContent = "Data saved successfully!"; el.sheetStatus.style.color = "var(--success)"; 
                Swal.fire("Success!", "Today's data has been saved to the daily sheet.", "success"); 
            }).catch((error) => { 
                if (error.message !== 'Offline') {
                    el.sheetStatus.textContent = "Save failed."; el.sheetStatus.style.color = "var(--danger)"; 
                } else {
                    el.sheetStatus.textContent = "Offline. Try again later."; el.sheetStatus.style.color = "var(--danger)";
                }
            }).finally(() => { 
                el.saveToSheetBtn.disabled = !navigator.onLine; 
                el.saveBtnText.classList.remove('hidden'); el.saveBtnSpinner.classList.add('hidden'); 
                setTimeout(() => { el.sheetStatus.textContent = "" }, 5000); 
            }); 
        }

        // --- Camera Scan Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            el.orderScanInput.value = decodedText; 
            handleOrderScanAddBarcode(); 
            stopCameraScan();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Barcode Scanned!', showConfirmButton: false, timer: 1500 });
            el.orderScanInput.focus(); // Ensure focus returns after closing the camera
        }
        function onScanFailure(error) { /* Do nothing to avoid console spam */ }
        function startCameraScan() {
            el.cameraModal.classList.add('show');
            if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            // Clear input field before starting scan
            el.orderScanInput.value = ""; 
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => { Swal.fire("Camera Error", "Could not start the camera. Please check permissions.", "error"); stopCameraScan(); });
        }
        function stopCameraScan() {
            if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); }
            el.cameraModal.classList.remove('show');
            el.orderScanInput.focus(); // Ensure focus returns to the input after closing the camera
        }
        
        document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>
</html>
