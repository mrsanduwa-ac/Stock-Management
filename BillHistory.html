<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bill History - World Out Fashion</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 15px;
            color: #333;
            margin: 0;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        /* Header & Nav */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; color: #0288d1; font-size: 24px; }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-back {
            text-decoration: none;
            background: #0288d1;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            display: inline-block;
        }

        .btn-refresh {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        /* Stats Cards */
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .card {
            flex: 1;
            background: #e1f5fe;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card h3 { margin: 0 0 8px 0; color: #555; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 22px; font-weight: bold; color: #0288d1; }

        /* Search Bar */
        .search-box {
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }
        input[type="text"]:focus {
            border-color: #0288d1;
            box-shadow: 0 0 8px rgba(2, 136, 209, 0.1);
        }

        /* Loading Spinner */
        #loading {
            text-align: center;
            padding: 40px;
            font-weight: bold;
            color: #666;
        }
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 4px solid #0288d1;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        th { background: #333; color: white; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f9f9f9; }

        .btn-edit {
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
            transition: 0.2s;
            margin-right: 5px;
        }
        .btn-edit:hover { background: #e68900; }

        .btn-delete {
            background: #dc3545; /* Red Color */
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
            transition: 0.2s;
        }
        .btn-delete:hover { background: #c82333; }

        /* --- SECURITY MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.open { display: flex; }
        
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.open .modal-box {
            transform: scale(1);
            opacity: 1;
        }

        .lock-icon {
            font-size: 40px;
            color: #333;
            margin-bottom: 15px;
            background: #f0f2f5;
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .pin-input {
            font-size: 24px;
            letter-spacing: 8px;
            text-align: center;
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            outline: none;
            transition: 0.3s;
            box-sizing: border-box;
        }
        .pin-input:focus { border-color: #0288d1; }

        .error-msg {
            color: #dc3545;
            font-size: 14px;
            margin-bottom: 15px;
            min-height: 20px;
            font-weight: bold;
        }

        .modal-btns { display: flex; gap: 10px; }
        
        .btn-unlock {
            background: #0288d1; color: white; flex: 1;
            border: none; padding: 12px; border-radius: 6px;
            font-weight: bold; cursor: pointer; font-size: 16px;
        }
        .btn-cancel {
            background: #f0f2f5; color: #333; flex: 1;
            border: none; padding: 12px; border-radius: 6px;
            font-weight: bold; cursor: pointer; font-size: 16px;
        }

        /* Shake Animation for Error */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
            100% { transform: translateX(0); }
        }
        .error-shake {
            animation: shake 0.4s ease-in-out;
            border-color: #dc3545 !important;
            background-color: #fff8f8;
        }

        /* --- MOBILE RESPONSIVE (CARD VIEW) --- */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .header-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .btn-back, .btn-refresh {
                flex: 1;
                text-align: center;
                padding: 12px 10px;
            }

            thead { display: none; }

            tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                padding: 15px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #f0f0f0;
                padding: 10px 0;
                text-align: right;
            }

            td:last-child {
                border-bottom: none;
                justify-content: center;
                padding-top: 15px;
                gap: 10px;
            }

            td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #555;
                text-transform: uppercase;
                font-size: 12px;
                text-align: left;
            }
            
            td[data-label="Invoice #"] { color: #0288d1; font-weight: bold; }
            td[data-label="Amount"] { color: #2e7d32; font-weight: bold; font-size: 16px; }
            
            .btn-edit, .btn-delete {
                flex: 1;
                padding: 12px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Invoice History</h1>
        <div class="header-buttons">
            <button class="btn-refresh" onclick="fetchData()">ðŸ”„ Sync</button>
            <a href="index.html" class="btn-back" onclick="localStorage.removeItem('editInvoiceId')">âž• New Invoice</a>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="stats">
        <div class="card">
            <h3>Total Invoices</h3>
            <div class="value" id="totalCount">0</div>
        </div>
        <div class="card">
            <h3>Total Revenue</h3>
            <div class="value" id="totalRevenue">Rs. 0.00</div>
        </div>
    </div>

    <!-- Search -->
    <div class="search-box">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search Invoice No or Customer...">
    </div>

    <!-- Loading State -->
    <div id="loading">
        <div class="spinner"></div> Syncing with Google Sheets...
    </div>

    <!-- Data Table -->
    <table id="historyTable" style="display: none;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Invoice #</th>
                <th>Customer Name</th>
                <th style="text-align: right;">Amount (Rs)</th>
                <th style="text-align: center;">Action</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Rows will be loaded here -->
        </tbody>
    </table>
</div>

<!-- PIN Code Modal -->
<div class="modal-overlay" id="pinModal">
    <div class="modal-box">
        <div class="lock-icon">ðŸ”’</div>
        <h3 style="margin: 0 0 20px;">Admin Access Required</h3>
        <input type="password" id="pinInput" class="pin-input" placeholder="****" maxlength="4" inputmode="numeric">
        <div id="pinError" class="error-msg"></div>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closePinModal()">Cancel</button>
            <button class="btn-unlock" onclick="submitPin()">Unlock & Delete</button>
        </div>
    </div>
</div>

<script>
    // -----------------------------------------------------
    // PASTE YOUR GOOGLE SCRIPT URL HERE
    // -----------------------------------------------------
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyUimQ5D7CwaEJAjfiDjC3tkN00ukZXoWjUCP_KqgQVJ7f9aV0BXECq0hkXrfUswb3urw/exec';
    // -----------------------------------------------------

    let targetInvoiceToDelete = null;

    // Load data on start
    window.onload = fetchData;

    function fetchData() {
        const loading = document.getElementById('loading');
        const table = document.getElementById('historyTable');
        const tbody = document.getElementById('tableBody');
        
        loading.style.display = 'block';
        table.style.display = 'none';
        tbody.innerHTML = '';

        if(scriptURL.includes('PASTE_YOUR')) {
            loading.innerHTML = "âš ï¸ Please paste your Google Script URL in the code.";
            return;
        }

        fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
            localStorage.setItem('worldOutFashionInvoices', JSON.stringify(data));
            displayData(data);
            loading.style.display = 'none';
            table.style.display = 'table';
        })
        .catch(error => {
            console.error('Error:', error);
            loading.innerHTML = "âŒ Connection Failed. Showing offline data.";
            const localData = JSON.parse(localStorage.getItem('worldOutFashionInvoices')) || [];
            if(localData.length > 0) {
                displayData(localData);
                table.style.display = 'table';
            }
        });
    }

    function displayData(history) {
        const tableBody = document.getElementById('tableBody');
        let totalRev = 0;
        
        history.sort((a, b) => b.id - a.id);

        history.forEach(inv => {
            const amount = parseFloat(inv.total) || 0;
            totalRev += amount;
            
            const row = `<tr>
                <td data-label="Date">${inv.date}</td>
                <td data-label="Invoice #"><strong>${inv.invNo}</strong></td>
                <td data-label="Customer">${inv.custName}</td>
                <td data-label="Amount" style="text-align: right;">${amount.toLocaleString('en-LK', {minimumFractionDigits: 2})}</td>
                <td style="text-align: center;">
                    <button class="btn-edit" onclick="editInvoice(${inv.id})">Edit</button>
                    <button class="btn-delete" onclick="promptDelete('${inv.invNo}')">Delete</button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        document.getElementById('totalCount').innerText = history.length;
        document.getElementById('totalRevenue').innerText = 'Rs. ' + totalRev.toLocaleString('en-LK', {minimumFractionDigits: 2});
    }

    function editInvoice(id) {
        localStorage.setItem('editInvoiceId', id);
        window.location.href = 'index.html';
    }

    // --- NEW MODAL FUNCTIONS ---

    function promptDelete(invNo) {
        targetInvoiceToDelete = invNo;
        document.getElementById('pinInput').value = '';
        document.getElementById('pinError').innerText = '';
        document.getElementById('pinInput').classList.remove('error-shake');
        
        const modal = document.getElementById('pinModal');
        modal.classList.add('open');
        
        // Focus input after animation
        setTimeout(() => document.getElementById('pinInput').focus(), 100);
    }

    function closePinModal() {
        document.getElementById('pinModal').classList.remove('open');
        targetInvoiceToDelete = null;
    }

    function submitPin() {
        const pin = document.getElementById('pinInput').value;
        const errorDiv = document.getElementById('pinError');
        const inputField = document.getElementById('pinInput');

        if (!pin) {
            errorDiv.innerText = "Please enter PIN";
            return;
        }

        // Processing UI
        const btn = document.querySelector('.btn-unlock');
        const originalText = btn.innerText;
        btn.innerText = "Checking...";
        btn.disabled = true;

        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'delete',
                invNo: targetInvoiceToDelete,
                pin: pin
            })
        })
        .then(response => response.json())
        .then(result => {
            // NOTE: With no-cors, this block might not execute with data.
            // But if it works, handle response.
            handleDeleteResponse(result);
        })
        .catch(err => {
            // Due to no-cors opacity, we assume success if no error, 
            // BUT for PIN check we really need feedback.
            // If CORS is an issue, we simulate the "Reload on Error" behavior here 
            // because we can't reliably read the "Incorrect PIN" JSON response.
            
            // However, assuming the Google Script is deployed as "Everyone", 
            // sometimes JSON is readable if not opaque. 
            
            // For now, let's simulate the delay and refresh as requested for safety.
            setTimeout(() => {
                // We will refresh to see if deletion happened.
                closePinModal();
                fetchData();
                btn.innerText = originalText;
                btn.disabled = false;
            }, 1000);
        });
        
        // Because of 'no-cors' limitations, reading the exact error message (Incorrect PIN)
        // is tricky. The script logic you have *does* return JSON.
        // If we can't read the JSON due to browser policy, we can't show "Incorrect PIN".
        
        // WORKAROUND for "If code wrong -> Auto Refresh":
        // We will assume the request goes through. If the user provided the WRONG pin,
        // the server script won't delete it.
        // We reload the page. If the item is still there, it implies failure (or pin wrong).
        
        // Let's implement the specific "Refresh on Error" visual effect requested.
        // Since we can't easily detect "Incorrect PIN" vs "Network Error" in no-cors mode,
        // we'll add a catch-all timeout.
        
        setTimeout(() => {
             // For the sake of the requested UI behavior:
             // If we were able to validate client-side we would.
             // Since server validates, we'll mimic the "Error -> Refresh" flow.
             
             // In a real app with CORS, we'd check result.result === 'error'.
             // Here, let's assume if it takes long or fails, we refresh.
             
             // To make the UI interactive as requested:
             // We'll reload the data.
             closePinModal();
             window.location.reload(); 
        }, 2000);
    }

    function handleDeleteResponse(result) {
        // This function would run if CORS allows reading response
        const errorDiv = document.getElementById('pinError');
        const inputField = document.getElementById('pinInput');
        
        if (result && result.result === 'error') {
            // Show Error Animation
            inputField.classList.add('error-shake');
            errorDiv.innerText = "Incorrect PIN!";
            
            // Auto Refresh after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            closePinModal();
            fetchData();
        }
    }

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('historyTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 0; i < tr.length; i++) { 
            const textContent = tr[i].textContent || tr[i].innerText;
            if (textContent.toLowerCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
</script>

</body>
</html>
